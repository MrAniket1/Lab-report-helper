<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Pathology Lab Report Generator</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
            body {
            font-family: 'Poppins', sans-serif;
            background-color: #F5F5F5;
            color: #424242;
            }
            .lab-header {
            background-color: #1A237E;
            color: white;
            padding: 1.5rem 0;
            border-bottom: 5px solid #42A5F5;
            }
            .lab-logo {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            }
            .card {
            border-radius: 0.75rem;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            border: none;
            }
            .report-preview {
            position: sticky;
            top: 1.5rem;
            height: calc(100vh - 3rem);
            overflow-y: auto;
            }
            .report-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            .value-low {
            color: #42A5F5;
            font-weight: 600;
            }
            .value-high {
            color: #EF5350;
            font-weight: 600;
            }
            .table th {
            background-color: #E0E0E0;
            color: #212121;
            }
            .table thead {
            border-bottom: 2px solid #bdbdbd;
            }
            .form-control, .form-select {
            border-radius: 0.5rem;
            border: 1px solid #E0E0E0;
            transition: all 0.2s;
            }
            .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(66, 165, 245, 0.25);
            border-color: #42A5F5;
            }
            .btn-primary {
            background-color: #1A237E;
            border-color: #1A237E;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
            }
            .btn-primary:hover {
            background-color: #283593;
            transform: translateY(-2px);
            }
            .btn-secondary {
            background-color: #757575;
            border-color: #757575;
            font-weight: 600;
            }
            .btn-secondary:hover {
            background-color: #616161;
            }
            .btn-outline-secondary {
            border-color: #9E9E9E;
            color: #616161;
            }
            .btn-outline-secondary:hover {
            background-color: #e0e0e0;
            color: #424242;
            }
            footer {
            margin-top: 3rem;
            padding: 2rem 0;
            text-align: center;
            font-size: 0.8rem;
            color: #6c757d;
            border-top: 1px solid #e0e0e0;
            }
            @media (max-width: 991.98px) {
            .report-preview {
            position: static;
            height: auto;
            margin-top: 1.5rem;
            }
            }
            @media print {
            body { background: white !important; }
            #footnote{ display: none !important; }
            .lab-header { 
            position: static !important; 
            background: #1A237E !important; 
            color: white !important; 
            border-bottom: 5px solid #42A5F5 !important;
            }
            main .row > .col-lg-7 { display: none !important; }
            main .row > .col-lg-5 { 
            flex: 0 0 100% !important; 
            max-width: 100% !important; 
            width: 100% !important;
            }
            .report-preview { 
            position: static !important; 
            height: auto !important; 
            top: auto !important;
            }
            #previewContent { 
            box-shadow: none !important; 
            border: none !important; 
            padding: 1rem !important;
            background: white !important;
            }
            footer { 
            position: static !important; 
            border-top: 1px solid #e0e0e0 !important; 
            color: #6c757d !important;
            page-break-inside: avoid;
            }
            .table { 
            font-size: 10pt !important; 
            width: 100% !important;
            }
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    </head>
    <body>
        <header class="lab-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="lab-logo">🔬 Yash Pathlab</div>
                    <div class="text-end">
                        <small>
                        Chodi, Barbaspur, Anuppur (M.P.) 484336<br>
                        📞 7879619498 • ukumar.kewat5@gmail.com
                        </small>
                    </div>
                </div>
            </div>
        </header>
        <main class="container my-2">
            <div class="row g-5">
                <div class="col-lg-7">
                    <div class="card p-4" id="patientDetailsPanel">
                        <h5 class="card-title mb-4">Patient Details & Test Selection</h5>
                        <div id="alertPlaceholder" class="mb-3"></div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="p_name" class="form-label">Patient Name</label>
                                <input type="text" id="p_name" class="form-control" placeholder="Enter name" required />
                            </div>
                            <div class="col-md-6">
                                <label for="p_id" class="form-label">Patient ID / Reg. No.</label>
                                <input type="text" id="p_id" class="form-control" placeholder="ID / MRN" />
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="p_age" class="form-label">Age (Years)</label>
                                <input type="number" id="p_age" class="form-control" min="0" placeholder="e.g., 35" required />
                            </div>
                            <div class="col-md-6">
                                <label for="p_gender" class="form-label">Gender</label>
                                <select id="p_gender" class="form-select">
                                    <option value="">-- Select Gender --</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="p_date" class="form-label">Sample Collection Date</label>
                                <input type="date" id="p_date" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label for="p_test" class="form-label">Select Test(s)</label>
                                <select id="p_test" class="form-select" multiple required>
                                    <option value="CBC">CBC — Complete Blood Count</option>
                                    <option value="LFT">LFT — Liver Function Test</option>
                                    <option value="KFT">KFT — Kidney/Renal Function Test</option>
                                    <option value="LIPID">Lipid Profile</option>
                                    <option value="TFT">Thyroid Function (TFT)</option>
                                    <option value="GLU">Glucose Panel</option>
                                    <option value="ELEC">Electrolytes</option>
                                    <option value="URINE">Urine R/E</option>
                                    <option value="IRON">Iron Studies</option>
                                    <option value="INFL">Inflammatory Markers (CRP/ESR)</option>
                                    <option value="MAL">Malaria Test</option>
                                    <option value="TYPH">Typhoid (Widal)</option>
                                    <option value="HBSAG">HBsAg</option>
                                    <option value="VITB12">Vitamin B12</option>
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple.</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="p_ref" class="form-label">Referring Doctor / Clinic (Optional)</label>
                            <input type="text" id="p_ref" class="form-control" placeholder="Doctor's Name, Clinic" />
                        </div>
                        <div class="d-flex gap-2 mt-4">
                            <button id="saveProceed" class="btn btn-primary">Proceed to Form &rarr;</button>
                        </div>
                    </div>
                    <div class="card p-4 mt-4 d-none" id="panelForm">
                        <h5 class="card-title" id="formHeading">Enter Values</h5>
                        <div id="paramsArea"></div>
                        <div class="d-flex gap-2 mt-4">
                            <button id="downloadPdf" class="btn btn-primary">⬇ Download PDF</button>
                            <button id="printReport" class="btn btn-success">🖨 Print Report</button>
                            <button id="backToHome" class="btn btn-secondary">← Back</button>
                            <button id="clearValues" class="btn btn-outline-secondary">Clear Values</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="report-preview">
                        <div class="report-card" id="previewContent">
                            <p class="text-muted text-center">Your report preview will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer>
            <div class="container text-center">
                <div id="footnote">
                    <p>© 2025 Yash Pathlab. All rights reserved.</p>
                    <p class="mt-2">Developed by: Aniket Ram Kewat | 📞 +91 6266562082 | ✉️ aniket07r+pathlab@gmail.com</p>
                </div>
            </div>
        </footer>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Data and Logic
            const TESTS = {
                "CBC": {
                    title: "Complete Blood Count",
                    params: [
                        { key: "Hemoglobin", unit: "g/dL", low: 13.5, high: 17.5, refMale: [13.5, 17.5], refFemale: [12.0, 15.5] },
                        { key: "RBC", unit: "million/µL", low: 4.5, high: 5.9, refMale: [4.5, 5.9], refFemale: [4.1, 5.1] },
                        { key: "WBC", unit: "thousand/µL", low: 4.0, high: 11.0 },
                        { key: "Platelets", unit: "thousand/µL", low: 150, high: 450 },
                        { key: "PCV (HCT)", unit: "%", low: 40, high: 54, refMale: [40, 54], refFemale: [36, 48] },
                        { key: "MCV", unit: "fL", low: 80, high: 100 },
                        { key: "MCH", unit: "pg", low: 27, high: 33 },
                        { key: "MCHC", unit: "g/dL", low: 32, high: 36 },
                        { key: "RDW-CV", unit: "%", low: 11.5, high: 14.5 },
                        { key: "Neutrophils", unit: "%", low: 40, high: 75 },
                        { key: "Lymphocytes", unit: "%", low: 20, high: 45 },
                        { key: "Eosinophils", unit: "%", low: 1, high: 6 },
                        { key: "Monocytes", unit: "%", low: 2, high: 10 },
                        { key: "Basophils", unit: "%", low: 0, high: 2 }
                    ]
                },
                "LFT": {
                    title: "Liver Function Test",
                    params: [
                        { key: "Total Bilirubin", unit: "mg/dL", low: 0.1, high: 1.2 },
                        { key: "Direct Bilirubin", unit: "mg/dL", low: 0, high: 0.3 },
                        { key: "Indirect Bilirubin", unit: "mg/dL", ro: true },
                        { key: "SGOT (AST)", unit: "U/L", low: 8, high: 48 },
                        { key: "SGPT (ALT)", unit: "U/L", low: 7, high: 55 },
                        { key: "Alkaline Phosphatase (ALP)", unit: "U/L", low: 44, high: 147 },
                        { key: "Total Protein", unit: "g/dL", low: 6.0, high: 8.3 },
                        { key: "Albumin", unit: "g/dL", low: 3.5, high: 5.0 },
                        { key: "Globulin", unit: "g/dL", ro: true },
                        { key: "A/G Ratio", unit: "", ro: true }
                    ]
                },
                "KFT": {
                    title: "Kidney Function Test",
                    params: [
                        { key: "Urea", unit: "mg/dL", low: 17, high: 43 },
                        { key: "Creatinine", unit: "mg/dL", low: 0.6, high: 1.3, refMale: [0.6, 1.3], refFemale: [0.5, 1.1] },
                        { key: "Uric Acid", unit: "mg/dL", low: 3.4, high: 7.0, refMale: [3.4, 7.0], refFemale: [2.4, 6.0] },
                        { key: "BUN", unit: "mg/dL", low: 6, high: 24 },
                        { key: "BUN/Creatinine Ratio", unit: "", ro: true },
                        { key: "Na (Sodium)", unit: "mmol/L", low: 135, high: 145 },
                        { key: "K (Potassium)", unit: "mmol/L", low: 3.5, high: 5.1 },
                        { key: "Cl (Chloride)", unit: "mmol/L", low: 98, high: 107 }
                    ]
                },
                "LIPID": {
                    title: "Lipid Profile",
                    params: [
                        { key: "Total Cholesterol", unit: "mg/dL", low: 0, high: 200 },
                        { key: "HDL Cholesterol", unit: "mg/dL", low: 40, high: 60, refMale: [40, 60], refFemale: [50, 60] },
                        { key: "LDL Cholesterol", unit: "mg/dL", low: 0, high: 100 },
                        { key: "Triglycerides", unit: "mg/dL", low: 0, high: 150 },
                        { key: "VLDL Cholesterol", unit: "mg/dL", ro: true },
                        { key: "Non-HDL Cholesterol", unit: "mg/dL", ro: true }
                    ]
                },
                "TFT": {
                    title: "Thyroid Function Test",
                    params: [
                        { key: "T3 (Total)", unit: "ng/dL", low: 80, high: 200 },
                        { key: "T4 (Total)", unit: "µg/dL", low: 4.5, high: 12.0 },
                        { key: "TSH", unit: "µIU/mL", low: 0.4, high: 4.2 }
                    ]
                },
                "GLU": {
                    title: "Glucose Panel",
                    params: [
                        { key: "Glucose (Fasting)", unit: "mg/dL", low: 70, high: 100 },
                        { key: "Glucose (PP)", unit: "mg/dL", low: 70, high: 140 },
                        { key: "Random Glucose", unit: "mg/dL", low: 70, high: 140 },
                        { key: "HbA1c", unit: "%", low: 4.0, high: 5.6 }
                    ]
                },
                "ELEC": {
                    title: "Electrolytes",
                    params: [
                        { key: "Sodium (Na+)", unit: "mmol/L", low: 135, high: 145 },
                        { key: "Potassium (K+)", unit: "mmol/L", low: 3.5, high: 5.1 },
                        { key: "Chloride (Cl-)", unit: "mmol/L", low: 98, high: 107 },
                        { key: "Calcium (Ca++)", unit: "mg/dL", low: 8.5, high: 10.2 }
                    ]
                },
                "URINE": {
                    title: "Urine R/E",
                    params: [
                        { key: "Color", unit: "", type: "select", options: ["Light Yellow", "Dark Yellow", "Amber", "Red", "Brown", "Colorless"], normalText: "Light Yellow" },
                        { key: "Appearance", unit: "", type: "select", options: ["Clear", "Slightly Cloudy", "Cloudy", "Turbid"], normalText: "Clear" },
                        { key: "pH", unit: "", low: 4.5, high: 8.0, normalText: "6.0" },
                        { key: "Specific Gravity", unit: "", low: 1.003, high: 1.030, normalText: "1.010" },
                        { key: "Glucose", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                        { key: "Proteins", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                        { key: "Ketones", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                        { key: "Blood", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                        { key: "Microscopic Exam", unit: "", type: "textarea", normalText: "Epithelial cells: 2-3 / HPF" }
                    ]
                },
                "IRON": {
                    title: "Iron Studies",
                    params: [
                        { key: "Serum Iron", unit: "µg/dL", low: 50, high: 150 },
                        { key: "Total Iron Binding Capacity", unit: "µg/dL", low: 250, high: 450 },
                        { key: "Ferritin", unit: "ng/mL", low: 20, high: 300, refMale: [20, 300], refFemale: [20, 150] }
                    ]
                },
                "INFL": {
                    title: "Inflammatory Markers",
                    params: [
                        { key: "C-Reactive Protein (CRP)", unit: "mg/L", high: 5.0, low: 0, normalText: "Normal" },
                        { key: "ESR (Westergren)", unit: "mm/hr", high: 20, low: 0, refMale: [0, 15], refFemale: [0, 20], normalText: "Normal" }
                    ]
                },
                "MAL": {
                    title: "Malaria Test",
                    params: [
                        { key: "MP Antigen (PF/PV)", unit: "", type: "select", options: ["Negative", "Positive"], normalText: "Negative" },
                        { key: "Peripheral Smear", unit: "", type: "textarea", normalText: "No malarial parasite seen." }
                    ]
                },
                "TYPH": {
                    title: "Typhoid (Widal)",
                    params: [
                        { key: "Typhoid 'O' (S. typhi)", unit: "Titre", low: 0, high: 160 },
                        { key: "Typhoid 'H' (S. typhi)", unit: "Titre", low: 0, high: 160 }
                    ]
                },
                "HBSAG": {
                    title: "HBsAg Test",
                    params: [
                        { key: "HBsAg", unit: "", type: "select", options: ["Non-Reactive", "Reactive"], normalText: "Non-Reactive" }
                    ]
             on gA(gender, minAge=0){ return (g,a)=> g===gender && a>=minAge }
    function ageBand(min,max){ return (g,a)=> a>=min && a<max }

    // Param schema:
    // { key, label?, unit?, type? ('number'|'select'|'text'), options?[],
    //   bands:[ { if:(g,a)=>bool, low, high, note? } ],
    //   compute?: (vals)=>number|string, depends?:['key1','key2'], ro?:true (readOnly)
    // }

    const TESTS = {
      // 1) CBC ----------------------------------------------------------------
      CBC: {
        title: 'COMPLETE BLOOD COUNT (CBC)',
        columns: ['Parameter','Observed Value','Unit','Biological Reference Interval','Flag'],
        params: [
          { key:'Hemoglobin', unit:'g/dL', bands:[
            { if:gA('M',12), low:13.0, high:17.0, note:'Male' },
            { if:gA('F',12), low:12.0, high:15.0, note:'Female' },
            { if:ageBand(5,12), low:11.5, high:15.5, note:'Child 5–12y' },
            { if:ageBand(1,5), low:11.0, high:14.0, note:'Child 1–5y' }
          ]},
          { key:'RBC Count', unit:'million/cmm', bands:[
            { if:gA('M',12), low:4.6, high:6.2 },
            { if:gA('F',12), low:4.2, high:5.4 }
          ]},
          { key:'Hematocrit', label:'Hematocrit (PCV)', unit:'%', bands:[{ if:always(), low:40, high:54 }]},
          { key:'MCV', unit:'fL', bands:[{ if:always(), low:80, high:96 }]},
          { key:'MCH', unit:'pg', bands:[{ if:always(), low:27, high:33 }]},
          { key:'MCHC', unit:'g/dL', bands:[{ if:always(), low:32, high:36 }]},
          { key:'RDW-CV', unit:'%', bands:[{ if:always(), low:11, high:16 }]},
          { key:'RDW-SD', unit:'fL', bands:[{ if:always(), low:35, high:56 }]},
          { key:'PLATELET COUNT', unit:'10^3/µL', bands:[{ if:always(), low:150, high:410 }]},
          { key:'MPV', unit:'fL', bands:[{ if:always(), low:6.5, high:12.0 }]},
          { key:'PDW', unit:'%', bands:[{ if:always(), low:25.0, high:65.0 }]},
          { key:'PCT', unit:'%', bands:[{ if:always(), low:0.108, high:0.282 }]},
          { key:'TOTAL WBC', label:'TOTAL COUNT (WBC), EDTA blood', unit:'10^3/µL', bands:[{ if:always(), low:4.0, high:10.0 }]},
          // Differential
          { key:'Neutrophils %', unit:'%', bands:[{ if:always(), low:38, high:70 }]},
          { key:'Lymphocytes %', unit:'%', bands:[{ if:always(), low:20, high:45 }]},
          { key:'Monocytes %', unit:'%', bands:[{ if:always(), low:2, high:8 }]},
          { key:'Eosinophils %', unit:'%', bands:[{ if:always(), low:1, high:4 }]},
          { key:'Basophils %', unit:'%', bands:[{ if:always(), low:0, high:1 }]},
          // Optional absolute counts (calculated from WBC * %)
          { key:'Neutrophils Abs', unit:'10^3/µL', ro:true, depends:['TOTAL WBC','Neutrophils %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Neutrophils %'])/100) },
          { key:'Lymphocytes Abs', unit:'10^3/µL', ro:true, depends:['TOTAL WBC','Lymphocytes %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Lymphocytes %'])/100) },
          { key:'Monocytes Abs', unit:'10^3/µL', ro:true, depends:['TOTAL WBC','Monocytes %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Monocytes %'])/100) },
          { key:'Eosinophils Abs', unit:'10^3/µL', ro:true, depends:['TOTAL WBC','Eosinophils %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Eosinophils %'])/100) },
          { key:'Basophils Abs', unit:'10^3/µL', ro:true, depends:['TOTAL WBC','Basophils %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Basophils %'])/100) }
        ]
      },

      // 2) LFT ----------------------------------------------------------------
      LFT: {
        title: 'LIVER FUNCTION TEST (LFT)', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Bilirubin Total', unit:'mg/dL', bands:[{ if:always(), low:0.1, high:1.2 }]},
          { key:'Bilirubin Direct', unit:'mg/dL', bands:[{ if:always(), low:0.0, high:0.3 }]},
          { key:'Bilirubin Indirect', unit:'mg/dL', ro:true, depends:['Bilirubin Total','Bilirubin Direct'], compute:(v)=> safe(num(v['Bilirubin Total'])-num(v['Bilirubin Direct'])) , bands:[{ if:always(), low:0.2, high:0.9 }]},
          { key:'AST (SGOT)', unit:'U/L', bands:[{ if:always(), low:0, high:40 }]},
          { key:'ALT (SGPT)', unit:'U/L', bands:[{ if:always(), low:0, high:40 }]},
          { key:'ALP', unit:'U/L', label:'Alkaline Phosphatase', bands:[{ if:always(), low:44, high:147 }]},
          { key:'GGT', unit:'U/L', bands:[{ if:always(), low:9, high:48 }]},
          { key:'Total Protein', unit:'g/dL', bands:[{ if:always(), low:6.0, high:8.3 }]},
          { key:'Albumin', unit:'g/dL', bands:[{ if:always(), low:3.5, high:5.0 }]},
          { key:'Globulin', unit:'g/dL', ro:true, depends:['Total Protein','Albumin'], compute:(v)=> safe(num(v['Total Protein'])-num(v['Albumin'])), bands:[{ if:always(), low:2.0, high:3.5 }]},
          { key:'A/G Ratio', unit:'', ro:true, depends:['Albumin','Globulin'], compute:(v)=> {
              const g=num(v['Globulin']); return g? round(num(v['Albumin'])/g):'';
            }, bands:[{ if:always(), low:1.0, high:2.2 }]}
        ]
      },

      // 3) KFT / RFT ----------------------------------------------------------
      KFT: {
        title:'KIDNEY / RENAL FUNCTION TEST (KFT)', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Urea', unit:'mg/dL', bands:[{ if:always(), low:15, high:40 }]},
          { key:'Creatinine', unit:'mg/dL', bands:[
            { if:gA('M',12), low:0.7, high:1.3 },
            { if:gA('F',12), low:0.6, high:1.1 }
          ]},
          { key:'Uric Acid', unit:'mg/dL', bands:[
            { if:gA('M',12), low:3.4, high:7.0 },
            { if:gA('F',12), low:2.4, high:6.0 }
          ]},
          { key:'BUN', unit:'mg/dL', ro:true, depends:['Urea'], compute:(v)=> round(num(v['Urea'])/2.14), bands:[{ if:always(), low:7, high:20 }]},
          { key:'BUN/Creatinine Ratio', unit:'', ro:true, depends:['BUN','Creatinine'], compute:(v)=> { const c=num(v['Creatinine']); return c? round(num(v['BUN'])/c):''; }, bands:[{ if:always(), low:10, high:20 }]}
        ]
      },

      // 4) Lipid Profile ------------------------------------------------------
      LIPID: {
        title:'LIPID PROFILE', columns:['Parameter','Observed Value','Unit','Desirable Range','Flag'],
        params:[
          { key:'Total Cholesterol', unit:'mg/dL', bands:[{ if:always(), low:0, high:200 }]},
          { key:'Triglycerides', unit:'mg/dL', bands:[{ if:always(), low:0, high:150 }]},
          { key:'HDL', unit:'mg/dL', bands:[{ if:always(), low:40, high:Infinity }]},
          { key:'LDL (calc)', unit:'mg/dL', ro:true, depends:['Total Cholesterol','HDL','Triglycerides'], compute:(v)=> safe(num(v['Total Cholesterol'])-num(v['HDL'])-num(v['Triglycerides'])/5), bands:[{ if:always(), low:0, high:100 }]},
          { key:'VLDL (calc)', unit:'mg/dL', ro:true, depends:['Triglycerides'], compute:(v)=> round(num(v['Triglycerides'])/5), bands:[{ if:always(), low:5, high:40 }]},
          { key:'TC/HDL Ratio', unit:'', ro:true, depends:['Total Cholesterol','HDL'], compute:(v)=> { const h=num(v['HDL']); return h? round(num(v['Total Cholesterol'])/h):''; }, bands:[{ if:always(), low:0, high:5 }]},
          { key:'Non-HDL Cholesterol', unit:'mg/dL', ro:true, depends:['Total Cholesterol','HDL'], compute:(v)=> safe(num(v['Total Cholesterol'])-num(v['HDL'])), bands:[{ if:always(), low:0, high:130 }]}
        ]
      },

      // 5) TFT ---------------------------------------------------------------
      TFT: {
        title:'THYROID FUNCTION TEST (TFT)', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'TSH', unit:'µIU/mL', bands:[{ if:always(), low:0.4, high:4.0 }]},
          { key:'Free T3', unit:'pg/mL', bands:[{ if:always(), low:2.0, high:4.4 }]},
          { key:'Free T4', unit:'ng/dL', bands:[{ if:always(), low:0.9, high:1.7 }]} 
        ]
      },

      // 6) Glucose Panel -----------------------------------------------------
      GLU: {
        title:'GLUCOSE PANEL', columns:['Parameter','Observed Value','Unit','Reference','Flag'],
        params:[
          { key:'Fasting Plasma Glucose', unit:'mg/dL', bands:[{ if:always(), low:70, high:99 }]},
          { key:'Postprandial (2h)', unit:'mg/dL', bands:[{ if:always(), low:70, high:139 }]},
          { key:'Random Glucose', unit:'mg/dL', bands:[{ if:always(), low:70, high:140 }]},
          { key:'HbA1c', unit:'%', bands:[{ if:always(), low:4.0, high:5.6 }]} 
        ]
      },

      // 7) Electrolytes ------------------------------------------------------
      ELEC: {
        title:'ELECTROLYTES', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Sodium (Na+)', unit:'mmol/L', bands:[{ if:always(), low:135, high:145 }]},
          { key:'Potassium (K+)', unit:'mmol/L', bands:[{ if:always(), low:3.5, high:5.1 }]},
        	{ key:'Chloride (Cl-)', unit:'mmol/L', bands:[{ if:always(), low:98, high:107 }]},
          { key:'Bicarbonate (HCO3-)', unit:'mmol/L', bands:[{ if:always(), low:22, high:29 }]} 
        ]
      },

      // 8) Urine R/E ---------------------------------------------------------
      URINE: {
        title:'URINE ROUTINE / MICROSCOPY (R/E)', columns:['Parameter','Observed Value','Unit','Reference / Normal','Flag'],
        params:[
          { key:'Colour', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Pale Yellow' },
          { key:'Appearance', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Clear' },
          { key:'Specific Gravity', unit:'', bands:[{ if:always(), low:1.005, high:1.030 }]},
          { key:'pH', unit:'', bands:[{ if:always(), low:4.5, high:8.0 }]},
          { key:'Protein', type:'select', options:['Negative','Trace','+','++','+++'], normalText:'Negative' },
          { key:'Glucose', type:'select', options:['Negative','Trace','+','++','+++'], normalText:'Negative' },
          { key:'Ketone', type:'select', options:['Negative','Trace','+','++','+++'], normalText:'Negative' },
          { key:'Bilirubin', type:'select', options:['Negative','Trace','+','++'], normalText:'Negative' },
          { key:'Urobilinogen', type:'select', options:['Normal','Increased'], normalText:'Normal' },
          { key:'Nitrite', type:'select', options:['Negative','Positive'], normalText:'Negative' },
          { key:'Leukocyte Esterase', type:'select', options:['Negative','Positive'], normalText:'Negative' },
          { key:'Blood', type:'select', options:['Negative','Positive'], normalText:'Negative' },
          // Microscopy
          { key:'Pus cells', unit:'/hpf', bands:[{ if:always(), low:0, high:5 }]},
          { key:'RBCs', unit:'/hpf', bands:[{ if:always(), low:0, high:2 }]},
          { key:'Epithelial cells', unit:'/hpf', bands:[{ if:always(), low:0, high:5 }]},
          { key:'Casts', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Nil' },
          { key:'Crystals', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Nil' },
          { key:'Others', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'-'}
        ]
      },

      // 9) Iron Studies -------------------------------------------------------
      IRON: {
        title:'IRON STUDIES', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Serum Iron', unit:'µg/dL', bands:[{ if:always(), low:60, high:170 }]},
          { key:'TIBC', unit:'µg/dL', label:'Total Iron Binding Capacity', bands:[{ if:always(), low:240, high:450 }]},
          { key:'Transferrin Saturation', unit:'%', ro:true, depends:['Serum Iron','TIBC'], compute:(v)=> { const t=num(v['TIBC']); return t? round((num(v['Serum Iron'])/t)*100):''; }, bands:[{ if:always(), low:20, high:50 }]},
          { key:'Ferritin', unit:'ng/mL', bands:[{ if:always(), low:30, high:400 }]} 
        ]
      },

      // 10) Inflammatory Markers ---------------------------------------------
      INFL: {
        title:'INFLAMMATORY MARKERS', columns:['Parameter','Observed Value','Unit','Reference','Flag'],
        params:[
          { key:'CRP', unit:'mg/L', label:'C-Reactive Protein', bands:[{ if:always(), low:0, high:5 }]},
          { key:'ESR', unit:'mm/hr', bands:[
            { if:gA('M',12), low:0, high:15 },
            { if:gA('F',12), low:0, high:20 }
          ]}
        ]
      }
    };

    // ====================== STATE & STORAGE ================================
    const KEY = 'labAppState_v2';
    const state = loadState() || {
      patient: { name:'', id:'', age:0, gender:'', date:'', ref:'' },
      selectedTest: '',
      values: {} // values[testKey][paramKey] = value
    };

    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }
    function resetState(){ localStorage.removeItem(KEY); location.reload(); }

    // ====================== UTIL ===========================================
    const el = {
      // nav
      btnHome: document.getElementById('btnHome'),
      btnForm: document.getElementById('btnForm'),
      btnReset: document.getElementById('btnReset'),
      // panels
      panelHome: document.getElementById('panelHome'),
      panelForm: document.getElementById('panelForm'),
      // home fields
      p_name: document.getElementById('p_name'),
      p_id: document.getElementById('p_id'),
      p_age: document.getElementById('p_age'),
      p_gender: document.getElementById('p_gender'),
      p_date: document.getElementById('p_date'),
      p_test: document.getElementById('p_test'),
      p_ref: document.getElementById('p_ref'),
      saveProceed: document.getElementById('saveProceed'),
      saveOnly: document.getElementById('saveOnly'),
      // form
      formHeading: document.getElementById('formHeading'),
      sel_test: document.getElementById('sel_test'),
      sel_patient: document.getElementById('sel_patient'),
      paramsArea: document.getElementById('paramsArea'),
      fillExample: document.getElementById('fillExample'),
      clearValues: document.getElementById('clearValues'),
      backToHome: document.getElementById('backToHome'),
      // preview
      rep_title: document.getElementById('rep_title'),
      rep_date: document.getElementById('rep_date'),
      rep_patient: document.getElementById('rep_patient'),
      rep_age: document.getElementById('rep_age'),
      rep_gender: document.getElementById('rep_gender'),
      rep_id: document.getElementById('rep_id'),
      rep_test: document.getElementById('rep_test'),
      rep_ref: document.getElementById('rep_ref'),
      resultTableHolder: document.getElementById('resultTableHolder'),
      downloadPdf: document.getElementById('downloadPdf')
    };

    function num(v){ const n=parseFloat(v); return isNaN(n)?0:n }
    function round(n){ return (n||n===0)? Math.round(n*100)/100 : '' }
    function safe(n){ const x = (typeof n==='number')? n : parseFloat(n); return isNaN(x)? '' : round(x) }

    // Panel switch
    function show(panel){
      el.panelHome.classList.toggle('hidden', panel!=='home');
      el.panelForm.classList.toggle('hidden', panel!=='form');
    }

    // Home load/save
    function loadHome(){
      const p=state.patient;
      el.p_name.value=p.name||''; el.p_id.value=p.id||''; el.p_age.value=p.age||'';
      el.p_gender.value=p.gender||''; el.p_date.value=p.date||''; el.p_test.value=state.selectedTest||''; el.p_ref.value=p.ref||'';
    }
    function saveHome(){
      state.patient={ name:el.p_name.value.trim(), id:el.p_id.value.trim(), age:Number(el.p_age.value||0), gender:el.p_gender.value, date:el.p_date.value, ref:el.p_ref.value.trim() };
      state.selectedTest=el.p_test.value; saveState(); refreshPreview(); }

    // Range resolver
    function resolveRange(param, gender, age){
      if(!param.bands) return {low:null,high:null,note:''};
      for(const b of param.bands){ if(b.if(gender,age)) return { low:(b.low??null), high:(b.high??null), note:(b.note||'') }; }
      return {low:null,high:null,note:''};
    }

    // Build Form
    function loadForm(){
      const tKey = state.selectedTest;
      const test = TESTS[tKey];
      el.formHeading.textContent = `Form — ${test?test.title:''}`;
      el.sel_test.value = test?test.title:'';
      el.sel_patient.value = `${state.patient.name||'-'} • ${state.patient.age||'-'}y ${state.patient.gender||'-'} • Reg:${state.patient.id||'-'}`;

      // table
      el.paramsArea.innerHTML='';
      if(!test){ el.paramsArea.innerHTML='<div class="notice">No test selected.</div>'; return; }
      const table=document.createElement('table');
      table.innerHTML='<thead><tr><th>Parameter</th><th>Normal Range</th><th>Value</th><th>Unit</th><th>Flag</th></tr></thead>';
      const tbody=document.createElement('tbody');

      test.params.forEach((p,idx)=>{
        const r=resolveRange(p, state.patient.gender, state.patient.age);
        const tr=document.createElement('tr');
        const rangeTxt=(r.low!=null&&r.high!=null)? `${r.low} - ${r.high}${p.unit?(' '+p.unit):''}` : (p.normalText? p.normalText : '—');
        const key=p.key; const val=(state.values[tKey]||{})[key] ?? '';
        const inputId=`inp_${tKey}_${idx}`;
        let inputHtml='';
        if(p.ro){
          inputHtml = `<input id="${inputId}" data-idx="${idx}" data-key="${key}" disabled placeholder="auto" value="${val}" />`;
        } else if(p.type==='select'){
          const opts=(p.options||[]).map(o=>`<option ${String(val)===String(o)?'selected':''}>${o}</option>`).join('');
          inputHtml = `<select id="${inputId}" data-idx="${idx}" data-key="${key}">${opts}</select>`;
        } else if(p.type==='text'){
          inputHtml = `<input id="${inputId}" data-idx="${idx}" data-key="${key}" placeholder="enter" value="${val}" />`;
        } else {
          inputHtml = `<input id="${inputId}" type="number" step="0.01" data-idx="${idx}" data-key="${key}" placeholder="0" value="${val}" />`;
        }
        tr.innerHTML = `<td>${p.label||p.key}</td><td class="small">${rangeTxt}${r.note?` <span class='subtle'>(${r.note})</span>`:''}</td><td>${inputHtml}</td><td>${p.unit||''}</td><td><span id="flag_${tKey}_${idx}"></span></td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody); el.paramsArea.appendChild(table);

      // bind inputs
      test.params.forEach((p,idx)=>{
        const inp=document.getElementById(`inp_${tKey}_${idx}`);
        if(!inp) return;
        inp.addEventListener('input',()=>{ onValueChange(tKey, idx); });
      });

      // compute once on load
      recalcComputed(); refreshPreview();
    }

    function onValueChange(tKey, idx){
      const test=TESTS[tKey]; if(!test) return; const p=test.params[idx]; const inp=document.getElementById(`inp_${tKey}_${idx}`); if(!p||!inp) return;
      const raw = (p.type==='select'||p.type==='text')? inp.value : (inp.value===''? '' : Number(inp.value));
      state.values[tKey] = state.values[tKey] || {}; state.values[tKey][p.key]=raw; saveState();
      // recompute dependents if any
      recalcComputed();
      // set flag for edited param
      setFlagFor(tKey, idx);
      refreshPreview();
    }

    function recalcComputed(){
      const tKey = state.selectedTest; const test = TESTS[tKey]; if(!test) return;
      const vals = state.values[tKey]||{};
      test.params.forEach((p,idx)=>{
        if(p.compute){ const v = p.compute(vals); const elInp=document.getElementById(`inp_${tKey}_${idx}`); if(elInp){ elInp.value=(v===''? '' : v); } vals[p.key]=v; setFlagFor(tKey, idx); }
      });
      state.values[tKey]=vals; saveState();
    }

    function setFlagFor(tKey, idx){
      const test=TESTS[tKey]; if(!test) return; const p=test.params[idx]; const flagSpan=document.getElementById(`flag_${tKey}_${idx}`); if(!flagSpan) return;
      const r=resolveRange(p, state.patient.gender, state.patient.age);
      if(p.type==='select' || p.type==='text'){ // qualitative
        const val = (state.values[tKey]||{})[p.key];
        if(val==null||val===''){ flagSpan.innerHTML=''; return; }
        if(p.normalText){ flagSpan.innerHTML = (String(val).toLowerCase()===String(p.normalText).toLowerCase())? '<span class="flag normal">Normal</span>' : '<span class="flag high">Abnormal</span>'; }
        else flagSpan.innerHTML='';
        return;
      }
      const val = parseFloat((state.values[tKey]||{})[p.key]);
      if(isNaN(val)){ flagSpan.innerHTML=''; return; }
      if(r.low==null||r.high==null){ flagSpan.innerHTML=''; return; }
      if(val<r.low) flagSpan.innerHTML='<span class="flag low">Low</span>';
      else if(val>r.high) flagSpan.innerHTML='<span class="flag high">High</span>';
      else flagSpan.innerHTML='<span class="flag normal">Normal</span>';
    }

    // Preview renderer
    function refreshPreview(){
      const p=state.patient; const tKey=state.selectedTest; const test=TESTS[tKey];
      el.rep_date.innerText = (p.date|| new Date().toISOString().slice(0,10));
      el.rep_patient.innerText = `Patient: ${p.name||'-'}`;
      el.rep_age.innerText = `Age: ${p.age||'-'}`;
      el.rep_gender.innerText = `Gender: ${p.gender||'-'}`;
      el.rep_id.innerText = `Reg. No: ${p.id||'-'}`;
      el.rep_test.innerText = `Test: ${test?test.title:'-'}`;
      el.rep_ref.innerText = `Ref. By: ${p.ref||'-'}`;

      if(!test){ el.resultTableHolder.innerHTML='<div class="legend">Select a test & enter values…</div>'; document.getElementById('sectionTitle').innerText=''; return; }

      document.getElementById('sectionTitle').innerText = test.title;
      const vals = state.values[tKey]||{};
      let html = `<table><thead><tr>${test.columns.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>`;
      test.params.forEach((p,idx)=>{
        const r=resolveRange(p, p.skipGender?null:state.patient.gender, state.patient.age);
        const value = (p.type==='select'||p.type==='text')? (vals[p.key]??'') : (vals[p.key]??'');        
        const showVal = (value===undefined||value==='')? '' : value;
        const flagSpanId = `flag_${tKey}_${idx}`;
        let rangeText = (r.low!=null&&r.high!=null)? `${r.low} - ${r.high}` : (p.normalText? p.normalText : '—');
        html += `<tr>
          <td>${p.label||p.key}</td>
          <td>${showVal}</td>
          <td>${p.unit||''}</td>
          <td class="small">${rangeText}${p.unit?(' '+p.unit):''}${r.note?` <span class='subtle'>(${r.note})</span>`:''}</td>
          <td><span id='${flagSpanId}'>${document.getElementById(flagSpanId)?document.getElementById(flagSpanId).innerHTML:''}</span></td>
        </tr>`;
      });
      html += '</tbody></table>';
      el.resultTableHolder.innerHTML = html;
      // after rewrite, recompute flags to ensure preview updated
      const t=TESTS[tKey]; if(t){ t.params.forEach((_,i)=>setFlagFor(tKey,i)); }
    }

    // ====================== PDF Download ===================================
    document.getElementById('downloadPdf').addEventListener('click',()=>{
      const element=document.getElementById('reportPreview');
      const opt={margin:10,filename:(state.patient.name||'report')+'.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
      if(typeof html2pdf==='undefined'){
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js';
        s.onload=()=>html2pdf().set(opt).from(element).save();
        document.body.appendChild(s);
      } else html2pdf().set(opt).from(element).save();
    });

    // ====================== NAV & EVENTS ===================================
    el.btnHome.onclick=()=>{ show('home'); };
    el.btnForm.onclick=()=>{ show('form'); };
    el.btnReset.onclick=()=>{ if(confirm('Reset all saved data?')) resetState(); };

    el.saveOnly.onclick=()=>{ saveHome(); alert('Saved'); };
    el.saveProceed.onclick=()=>{ saveHome(); show('form'); loadForm(); };
    el.backToHome.onclick=()=>{ show('home'); };

    el.fillExample.onclick=()=>{
      const tKey=state.selectedTest; const test=TESTS[tKey]; if(!test) return;
      state.values[tKey]=state.values[tKey]||{};
      // very light demo values (safe defaults)
      test.params.forEach(p=>{
        if(p.ro) return; if(p.type==='select'){ state.values[tKey][p.key]= (p.normalText|| (p.options?p.options[0]:'-')); }
        else if(p.type==='text'){ state.values[tKey][p.key]= p.normalText||''; }
        else { // numeric
          const r=resolveRange(p, state.patient.gender, state.patient.age);
          if(r.low!=null&&r.high!=null){ state.values[tKey][p.key]= round((r.low+r.high)/2); }
        }
      });
      saveState(); loadForm(); refreshPreview();
    };

    el.clearValues.onclick=()=>{ const tKey=state.selectedTest; if(!tKey) return; state.values[tKey] = {}; saveState(); loadForm(); };

    // ====================== INIT ===========================================
    document.addEventListener('DOMContentLoaded',()=>{
      loadHome(); refreshPreview();
      // if already selected test & values exist, show form
      if(state.selectedTest){ show('form'); loadForm(); }
      else show('home');
    });
  </script>
</body>
</html>
