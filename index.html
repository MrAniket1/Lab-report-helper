<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Lab Software</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #f6f8fb;
  --card: #fff;
  --muted: #6b7280;
  --accent: #0f172a;
  --success: #059669;
  --danger: #ef4444;
  --warning: #f59e0b;
  --primary: #004aad;   /* Premium Blue */
  --secondary: #eab308; /* Gold Accent */
}

* {
  box-sizing: border-box;
  font-family: 'Inter', 'Segoe UI', system-ui, Arial, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--accent);
}

/* ----- HEADER ----- */
header {
  position: sticky;
  top: 0;
  width: 100%;
  background: var(--primary);  /* full width blue strip */
  color: #fff;
  z-index: 10;
}

header .bar {
  max-width: 1200px;  /* content limited */
  margin: 0 auto;     /* center aligned */
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  width: 100%;        /* ‚úÖ ensure it fills available space */
}

header .title {
  font-weight: 700;
  font-size: 20px;
  letter-spacing: 0.4px;
}

header .controls button {
  background: var(--secondary);
  color: #000;
  border: none;
  font-weight: 600;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
}

/* ----- MAIN LAYOUT ----- */
main {
  max-width: 1200px;
  margin: 20px auto;
  padding: 0 16px;
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 20px;
}

.card {
  background: var(--card);
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
}

h2 {
  margin: 0 0 12px;
  font-size: 18px;
  color: var(--primary);
  border-bottom: 2px solid var(--secondary);
  padding-bottom: 4px;
}

label {
  display: block;
  margin-top: 10px;
  font-size: 13px;
  color: var(--muted);
}

input, select, textarea {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 8px;
  border: 1px solid #e6e9ef;
  font-size: 14px;
  background: #fff;
}

textarea {
  min-height: 72px;
  resize: vertical;
}

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 12px;
}

button {
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

button.primary { background: var(--primary); color: #fff; }
button.secondary { background: var(--secondary); color: #000; }
button.ghost { background: #fff; color: var(--accent); border: 1px solid #e6e9ef; }

/* ----- TABLE ----- */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 14px;
}

th, td {
  padding: 8px 10px;
  border: 1px solid #e5e7eb;
  text-align: left;
  vertical-align: top;
}

th {
  font-weight: 600;
  background: var(--primary);
  color: #fff;
}

tbody tr:nth-child(even) {
  background: #f9fafb;
}

/* Flags */
.flag {
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 12px;
}

.flag.low { background: rgba(239,68,68,.1); color: var(--danger); }
.flag.normal { background: rgba(5,150,105,.12); color: var(--success); }
.flag.high { background: rgba(245,158,11,.15); color: var(--warning); }

/* ----- REPORT PREVIEW ----- */
.preview {
  overflow: auto;
  max-height: 78vh;
}

.report {
  width: 100%;
  padding: 20px;
  border-radius: 12px;
  background: #fff;
}

.report h3 {
  margin: 0;
  color: var(--primary);
}

.meta {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.meta div {
  font-size: 13px;
  color: var(--muted);
}

.legend, .notice {
  font-size: 12px;
  color: var(--muted);
  margin-top: 6px;
}

.sectionTitle {
  margin: 12px 0 6px;
  font-weight: 700;
}

/* ----- FOOTER ----- */
footer {
  text-align: center;
  font-size: 13px;
  color: var(--muted);
  margin-top: 20px;
}

footer::before {
  content: "‚Äî‚Äî End of Report ‚Äî‚Äî";
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--secondary);
}

/* ----- RESPONSIVE ----- */
@media(max-width: 980px) {
  main { grid-template-columns: 1fr; }
  .preview { max-height: none; }
}

@media(max-width: 600px) {
  body { font-size: 14px; }

  header .bar { flex-direction: column; align-items: flex-start; gap: 8px; }

  .card { padding: 14px; border-radius: 10px; }

  input, select { font-size: 13px; padding: 8px; }

  button { width: 100%; margin-top: 8px; }

  table { display: block; overflow-x: auto; white-space: nowrap; border-radius: 8px; }
  th, td { font-size: 13px; padding: 8px 6px; }
}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">üß™ Lab Report ‚Äî Advanced</div>
      <div class="controls">
        <button class="ghost" id="btnHome">Home</button>
        <button class="ghost" id="btnForm">Form</button>
        <button class="ghost" id="btnReset">Reset</button>
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT: App Panels -->
    <section class="card" id="panelHome">
      <h2>Index ‚Äî Patient Details & Test Selection</h2>
      <div class="row">
        <div>
          <label>Patient Name</label>
          <input id="p_name" placeholder="Patient ka naam" />
        </div>
        <div>
          <label>Patient ID / Reg. No.</label>
          <input id="p_id" placeholder="ID / MRN" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Age (years)</label>
          <input id="p_age" type="number" min="0" placeholder="e.g. 35" />
        </div>
        <div>
          <label>Gender</label>
          <select id="p_gender">
            <option value="">-- Select Gender --</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Collection Date</label>
          <input id="p_date" type="date" />
        </div>
        <div>
          <label>Select Test</label>
          <select id="p_test">
            <option value="">-- Select Test --</option>
            <option value="CBC">CBC ‚Äî Complete Blood Count</option>
            <option value="LFT">LFT ‚Äî Liver Function Test</option>
            <option value="KFT">KFT ‚Äî Kidney/Renal Function Test</option>
            <option value="LIPID">Lipid Profile</option>
            <option value="TFT">Thyroid Function (TFT)</option>
            <option value="GLU">Glucose Panel</option>
            <option value="ELEC">Electrolytes</option>
            <option value="URINE">Urine R/E</option>
            <option value="IRON">Iron Studies</option>
            <option value="INFL">Inflammatory Markers (CRP/ESR)</option>
          </select>
        </div>
      </div>
      <label>Ref. By (Doctor / Clinic) ‚Äî optional</label>
      <input id="p_ref" placeholder="Dr. Name, Clinic" />

      <div class="controls">
        <button id="saveProceed">Proceed to Form ‚Üí</button>
        <button class="secondary" id="saveOnly">Save</button>
      </div>
      <div class="notice">Yahaan save karne par sab details <b>localStorage</b> me store hongi aur Form panel me auto-load ho jayengi.</div>
    </section>

    <section class="card hidden" id="panelForm">
      <h2 id="formHeading">Form ‚Äî </h2>
      <div class="row">
        <div>
          <label>Selected Test</label>
          <input id="sel_test" disabled />
        </div>
        <div>
          <label>Patient</label>
          <input id="sel_patient" disabled />
        </div>
      </div>
      <div id="paramsArea" style="margin-top:8px"></div>
      <div class="controls">
        <button id="fillExample">Fill Example</button>
        <button class="secondary" id="clearValues">Clear</button>
        <button id="downloadPdf">Download PDF</button>
        <button class="ghost" id="backToHome">‚Üê Back</button>
      </div>
    </section>

    <!-- RIGHT: Live Preview -->
    <aside class="card preview" id="panelPreview">
      <div class="report" id="reportPreview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 id="rep_title" style="text-align:center">LOGO</h3>
            <div style="font-size:12px;color:var(--muted)">Your Lab Name ‚Ä¢ Address ‚Ä¢ Contact</div>
          </div>
          <div class="legend">Report Date: <span id="rep_date"></span></div>
        </div>
        <div class="meta" style="margin-top:8px">
          <div id="rep_patient">Patient: -</div>
          <div id="rep_age">Age: -</div>
          <div id="rep_gender">Gender: -</div>
          <div id="rep_id">Reg. No: -</div>
          <div id="rep_test">Test: -</div>
          <div id="rep_ref" class="subtle">Ref. By: -</div>
        </div>
        <hr style="margin:12px 0;border:none;border-top:2px solid #111" />
        <div id="sectionTitle" class="sectionTitle"></div>
        <div id="resultTableHolder"><div class="legend">Select a test & enter values‚Ä¶</div></div>
        <div style="margin-top:10px" class="legend">Legend: <span class="flag low">Low</span> <span class="flag normal">Normal</span> <span class="flag high">High</span></div>
        <div style="margin-top:18px;font-size:13px;color:var(--muted)">Interpretation: Values are compared with reference intervals based on age/gender where applicable.</div>
        <div style="margin-top:24px;display:flex;justify-content:space-between;align-items:end">
          <div class="legend">-------------------------- End of Report --------------------------</div>
          <div style="text-align:right">
            <div style="height:38px"></div>
            <div style="font-size:13px;color:var(--muted)">Authorized Signatory</div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    // ====================== CONFIG: TESTS & RANGES ==========================
    // Helper predicates for bands (age/gender-wise ranges)
    function always(){ return (g,a)=>true }
    function gA(gender, minAge=0){ return (g,a)=> g===gender && a>=minAge }
    function ageBand(min,max){ return (g,a)=> a>=min && a<max }

    // Param schema:
    // { key, label?, unit?, type? ('number'|'select'|'text'), options?[],
    //   bands:[ { if:(g,a)=>bool, low, high, note? } ],
    //   compute?: (vals)=>number|string, depends?:['key1','key2'], ro?:true (readOnly)
    // }

    const TESTS = {
      // 1) CBC ----------------------------------------------------------------
      CBC: {
        title: 'COMPLETE BLOOD COUNT (CBC)',
        columns: ['Parameter','Observed Value','Unit','Biological Reference Interval','Flag'],
        params: [
          { key:'Hemoglobin', unit:'g/dL', bands:[
            { if:gA('M',12), low:13.0, high:17.0, note:'Male' },
            { if:gA('F',12), low:12.0, high:15.0, note:'Female' },
            { if:ageBand(5,12), low:11.5, high:15.5, note:'Child 5‚Äì12y' },
            { if:ageBand(1,5), low:11.0, high:14.0, note:'Child 1‚Äì5y' }
          ]},
          { key:'RBC Count', unit:'million/cmm', bands:[
            { if:gA('M',12), low:4.6, high:6.2 },
            { if:gA('F',12), low:4.2, high:5.4 }
          ]},
          { key:'Hematocrit', label:'Hematocrit (PCV)', unit:'%', bands:[{ if:always(), low:40, high:54 }]},
          { key:'MCV', unit:'fL', bands:[{ if:always(), low:80, high:96 }]},
          { key:'MCH', unit:'pg', bands:[{ if:always(), low:27, high:33 }]},
          { key:'MCHC', unit:'g/dL', bands:[{ if:always(), low:32, high:36 }]},
          { key:'RDW-CV', unit:'%', bands:[{ if:always(), low:11, high:16 }]},
          { key:'RDW-SD', unit:'fL', bands:[{ if:always(), low:35, high:56 }]},
          { key:'PLATELET COUNT', unit:'10^3/¬µL', bands:[{ if:always(), low:150, high:410 }]},
          { key:'MPV', unit:'fL', bands:[{ if:always(), low:6.5, high:12.0 }]},
          { key:'PDW', unit:'%', bands:[{ if:always(), low:25.0, high:65.0 }]},
          { key:'PCT', unit:'%', bands:[{ if:always(), low:0.108, high:0.282 }]},
          { key:'TOTAL WBC', label:'TOTAL COUNT (WBC), EDTA blood', unit:'10^3/¬µL', bands:[{ if:always(), low:4.0, high:10.0 }]},
          // Differential
          { key:'Neutrophils %', unit:'%', bands:[{ if:always(), low:38, high:70 }]},
          { key:'Lymphocytes %', unit:'%', bands:[{ if:always(), low:20, high:45 }]},
          { key:'Monocytes %', unit:'%', bands:[{ if:always(), low:2, high:8 }]},
          { key:'Eosinophils %', unit:'%', bands:[{ if:always(), low:1, high:4 }]},
          { key:'Basophils %', unit:'%', bands:[{ if:always(), low:0, high:1 }]},
          // Optional absolute counts (calculated from WBC * %)
          { key:'Neutrophils Abs', unit:'10^3/¬µL', ro:true, depends:['TOTAL WBC','Neutrophils %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Neutrophils %'])/100) },
          { key:'Lymphocytes Abs', unit:'10^3/¬µL', ro:true, depends:['TOTAL WBC','Lymphocytes %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Lymphocytes %'])/100) },
          { key:'Monocytes Abs', unit:'10^3/¬µL', ro:true, depends:['TOTAL WBC','Monocytes %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Monocytes %'])/100) },
          { key:'Eosinophils Abs', unit:'10^3/¬µL', ro:true, depends:['TOTAL WBC','Eosinophils %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Eosinophils %'])/100) },
          { key:'Basophils Abs', unit:'10^3/¬µL', ro:true, depends:['TOTAL WBC','Basophils %'],
            compute:(v)=> num(v['TOTAL WBC'])*(num(v['Basophils %'])/100) }
        ]
      },

      // 2) LFT ----------------------------------------------------------------
      LFT: {
        title: 'LIVER FUNCTION TEST (LFT)', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Bilirubin Total', unit:'mg/dL', bands:[{ if:always(), low:0.1, high:1.2 }]},
          { key:'Bilirubin Direct', unit:'mg/dL', bands:[{ if:always(), low:0.0, high:0.3 }]},
          { key:'Bilirubin Indirect', unit:'mg/dL', ro:true, depends:['Bilirubin Total','Bilirubin Direct'], compute:(v)=> safe(num(v['Bilirubin Total'])-num(v['Bilirubin Direct'])) , bands:[{ if:always(), low:0.2, high:0.9 }]},
          { key:'AST (SGOT)', unit:'U/L', bands:[{ if:always(), low:0, high:40 }]},
          { key:'ALT (SGPT)', unit:'U/L', bands:[{ if:always(), low:0, high:40 }]},
          { key:'ALP', unit:'U/L', label:'Alkaline Phosphatase', bands:[{ if:always(), low:44, high:147 }]},
          { key:'GGT', unit:'U/L', bands:[{ if:always(), low:9, high:48 }]},
          { key:'Total Protein', unit:'g/dL', bands:[{ if:always(), low:6.0, high:8.3 }]},
          { key:'Albumin', unit:'g/dL', bands:[{ if:always(), low:3.5, high:5.0 }]},
          { key:'Globulin', unit:'g/dL', ro:true, depends:['Total Protein','Albumin'], compute:(v)=> safe(num(v['Total Protein'])-num(v['Albumin'])), bands:[{ if:always(), low:2.0, high:3.5 }]},
          { key:'A/G Ratio', unit:'', ro:true, depends:['Albumin','Globulin'], compute:(v)=> {
              const g=num(v['Globulin']); return g? round(num(v['Albumin'])/g):'';
            }, bands:[{ if:always(), low:1.0, high:2.2 }]}
        ]
      },

      // 3) KFT / RFT ----------------------------------------------------------
      KFT: {
        title:'KIDNEY / RENAL FUNCTION TEST (KFT)', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Urea', unit:'mg/dL', bands:[{ if:always(), low:15, high:40 }]},
          { key:'Creatinine', unit:'mg/dL', bands:[
            { if:gA('M',12), low:0.7, high:1.3 },
            { if:gA('F',12), low:0.6, high:1.1 }
          ]},
          { key:'Uric Acid', unit:'mg/dL', bands:[
            { if:gA('M',12), low:3.4, high:7.0 },
            { if:gA('F',12), low:2.4, high:6.0 }
          ]},
          { key:'BUN', unit:'mg/dL', ro:true, depends:['Urea'], compute:(v)=> round(num(v['Urea'])/2.14), bands:[{ if:always(), low:7, high:20 }]},
          { key:'BUN/Creatinine Ratio', unit:'', ro:true, depends:['BUN','Creatinine'], compute:(v)=> { const c=num(v['Creatinine']); return c? round(num(v['BUN'])/c):''; }, bands:[{ if:always(), low:10, high:20 }]}
        ]
      },

      // 4) Lipid Profile ------------------------------------------------------
      LIPID: {
        title:'LIPID PROFILE', columns:['Parameter','Observed Value','Unit','Desirable Range','Flag'],
        params:[
          { key:'Total Cholesterol', unit:'mg/dL', bands:[{ if:always(), low:0, high:200 }]},
          { key:'Triglycerides', unit:'mg/dL', bands:[{ if:always(), low:0, high:150 }]},
          { key:'HDL', unit:'mg/dL', bands:[{ if:always(), low:40, high:Infinity }]},
          { key:'LDL (calc)', unit:'mg/dL', ro:true, depends:['Total Cholesterol','HDL','Triglycerides'], compute:(v)=> safe(num(v['Total Cholesterol'])-num(v['HDL'])-num(v['Triglycerides'])/5), bands:[{ if:always(), low:0, high:100 }]},
          { key:'VLDL (calc)', unit:'mg/dL', ro:true, depends:['Triglycerides'], compute:(v)=> round(num(v['Triglycerides'])/5), bands:[{ if:always(), low:5, high:40 }]},
          { key:'TC/HDL Ratio', unit:'', ro:true, depends:['Total Cholesterol','HDL'], compute:(v)=> { const h=num(v['HDL']); return h? round(num(v['Total Cholesterol'])/h):''; }, bands:[{ if:always(), low:0, high:5 }]},
          { key:'Non-HDL Cholesterol', unit:'mg/dL', ro:true, depends:['Total Cholesterol','HDL'], compute:(v)=> safe(num(v['Total Cholesterol'])-num(v['HDL'])), bands:[{ if:always(), low:0, high:130 }]}
        ]
      },

      // 5) TFT ---------------------------------------------------------------
      TFT: {
        title:'THYROID FUNCTION TEST (TFT)', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'TSH', unit:'¬µIU/mL', bands:[{ if:always(), low:0.4, high:4.0 }]},
          { key:'Free T3', unit:'pg/mL', bands:[{ if:always(), low:2.0, high:4.4 }]},
          { key:'Free T4', unit:'ng/dL', bands:[{ if:always(), low:0.9, high:1.7 }]} 
        ]
      },

      // 6) Glucose Panel -----------------------------------------------------
      GLU: {
        title:'GLUCOSE PANEL', columns:['Parameter','Observed Value','Unit','Reference','Flag'],
        params:[
          { key:'Fasting Plasma Glucose', unit:'mg/dL', bands:[{ if:always(), low:70, high:99 }]},
          { key:'Postprandial (2h)', unit:'mg/dL', bands:[{ if:always(), low:70, high:139 }]},
          { key:'Random Glucose', unit:'mg/dL', bands:[{ if:always(), low:70, high:140 }]},
          { key:'HbA1c', unit:'%', bands:[{ if:always(), low:4.0, high:5.6 }]} 
        ]
      },

      // 7) Electrolytes ------------------------------------------------------
      ELEC: {
        title:'ELECTROLYTES', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Sodium (Na+)', unit:'mmol/L', bands:[{ if:always(), low:135, high:145 }]},
          { key:'Potassium (K+)', unit:'mmol/L', bands:[{ if:always(), low:3.5, high:5.1 }]},
        	{ key:'Chloride (Cl-)', unit:'mmol/L', bands:[{ if:always(), low:98, high:107 }]},
          { key:'Bicarbonate (HCO3-)', unit:'mmol/L', bands:[{ if:always(), low:22, high:29 }]} 
        ]
      },

      // 8) Urine R/E ---------------------------------------------------------
      URINE: {
        title:'URINE ROUTINE / MICROSCOPY (R/E)', columns:['Parameter','Observed Value','Unit','Reference / Normal','Flag'],
        params:[
          { key:'Colour', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Pale Yellow' },
          { key:'Appearance', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Clear' },
          { key:'Specific Gravity', unit:'', bands:[{ if:always(), low:1.005, high:1.030 }]},
          { key:'pH', unit:'', bands:[{ if:always(), low:4.5, high:8.0 }]},
          { key:'Protein', type:'select', options:['Negative','Trace','+','++','+++'], normalText:'Negative' },
          { key:'Glucose', type:'select', options:['Negative','Trace','+','++','+++'], normalText:'Negative' },
          { key:'Ketone', type:'select', options:['Negative','Trace','+','++','+++'], normalText:'Negative' },
          { key:'Bilirubin', type:'select', options:['Negative','Trace','+','++'], normalText:'Negative' },
          { key:'Urobilinogen', type:'select', options:['Normal','Increased'], normalText:'Normal' },
          { key:'Nitrite', type:'select', options:['Negative','Positive'], normalText:'Negative' },
          { key:'Leukocyte Esterase', type:'select', options:['Negative','Positive'], normalText:'Negative' },
          { key:'Blood', type:'select', options:['Negative','Positive'], normalText:'Negative' },
          // Microscopy
          { key:'Pus cells', unit:'/hpf', bands:[{ if:always(), low:0, high:5 }]},
          { key:'RBCs', unit:'/hpf', bands:[{ if:always(), low:0, high:2 }]},
          { key:'Epithelial cells', unit:'/hpf', bands:[{ if:always(), low:0, high:5 }]},
          { key:'Casts', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Nil' },
          { key:'Crystals', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'Nil' },
          { key:'Others', type:'text', bands:[{ if:always(), low:null, high:null }], normalText:'-'}
        ]
      },

      // 9) Iron Studies -------------------------------------------------------
      IRON: {
        title:'IRON STUDIES', columns:['Parameter','Observed Value','Unit','Reference Interval','Flag'],
        params:[
          { key:'Serum Iron', unit:'¬µg/dL', bands:[{ if:always(), low:60, high:170 }]},
          { key:'TIBC', unit:'¬µg/dL', label:'Total Iron Binding Capacity', bands:[{ if:always(), low:240, high:450 }]},
          { key:'Transferrin Saturation', unit:'%', ro:true, depends:['Serum Iron','TIBC'], compute:(v)=> { const t=num(v['TIBC']); return t? round((num(v['Serum Iron'])/t)*100):''; }, bands:[{ if:always(), low:20, high:50 }]},
          { key:'Ferritin', unit:'ng/mL', bands:[{ if:always(), low:30, high:400 }]} 
        ]
      },

      // 10) Inflammatory Markers ---------------------------------------------
      INFL: {
        title:'INFLAMMATORY MARKERS', columns:['Parameter','Observed Value','Unit','Reference','Flag'],
        params:[
          { key:'CRP', unit:'mg/L', label:'C-Reactive Protein', bands:[{ if:always(), low:0, high:5 }]},
          { key:'ESR', unit:'mm/hr', bands:[
            { if:gA('M',12), low:0, high:15 },
            { if:gA('F',12), low:0, high:20 }
          ]}
        ]
      }
    };

    // ====================== STATE & STORAGE ================================
    const KEY = 'labAppState_v2';
    const state = loadState() || {
      patient: { name:'', id:'', age:0, gender:'', date:'', ref:'' },
      selectedTest: '',
      values: {} // values[testKey][paramKey] = value
    };

    function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }
    function resetState(){ localStorage.removeItem(KEY); location.reload(); }

    // ====================== UTIL ===========================================
    const el = {
      // nav
      btnHome: document.getElementById('btnHome'),
      btnForm: document.getElementById('btnForm'),
      btnReset: document.getElementById('btnReset'),
      // panels
      panelHome: document.getElementById('panelHome'),
      panelForm: document.getElementById('panelForm'),
      // home fields
      p_name: document.getElementById('p_name'),
      p_id: document.getElementById('p_id'),
      p_age: document.getElementById('p_age'),
      p_gender: document.getElementById('p_gender'),
      p_date: document.getElementById('p_date'),
      p_test: document.getElementById('p_test'),
      p_ref: document.getElementById('p_ref'),
      saveProceed: document.getElementById('saveProceed'),
      saveOnly: document.getElementById('saveOnly'),
      // form
      formHeading: document.getElementById('formHeading'),
      sel_test: document.getElementById('sel_test'),
      sel_patient: document.getElementById('sel_patient'),
      paramsArea: document.getElementById('paramsArea'),
      fillExample: document.getElementById('fillExample'),
      clearValues: document.getElementById('clearValues'),
      backToHome: document.getElementById('backToHome'),
      // preview
      rep_title: document.getElementById('rep_title'),
      rep_date: document.getElementById('rep_date'),
      rep_patient: document.getElementById('rep_patient'),
      rep_age: document.getElementById('rep_age'),
      rep_gender: document.getElementById('rep_gender'),
      rep_id: document.getElementById('rep_id'),
      rep_test: document.getElementById('rep_test'),
      rep_ref: document.getElementById('rep_ref'),
      resultTableHolder: document.getElementById('resultTableHolder'),
      downloadPdf: document.getElementById('downloadPdf')
    };

    function num(v){ const n=parseFloat(v); return isNaN(n)?0:n }
    function round(n){ return (n||n===0)? Math.round(n*100)/100 : '' }
    function safe(n){ const x = (typeof n==='number')? n : parseFloat(n); return isNaN(x)? '' : round(x) }

    // Panel switch
    function show(panel){
      el.panelHome.classList.toggle('hidden', panel!=='home');
      el.panelForm.classList.toggle('hidden', panel!=='form');
    }

    // Home load/save
    function loadHome(){
      const p=state.patient;
      el.p_name.value=p.name||''; el.p_id.value=p.id||''; el.p_age.value=p.age||'';
      el.p_gender.value=p.gender||''; el.p_date.value=p.date||''; el.p_test.value=state.selectedTest||''; el.p_ref.value=p.ref||'';
    }
    function saveHome(){
      state.patient={ name:el.p_name.value.trim(), id:el.p_id.value.trim(), age:Number(el.p_age.value||0), gender:el.p_gender.value, date:el.p_date.value, ref:el.p_ref.value.trim() };
      state.selectedTest=el.p_test.value; saveState(); refreshPreview(); }

    // Range resolver
    function resolveRange(param, gender, age){
      if(!param.bands) return {low:null,high:null,note:''};
      for(const b of param.bands){ if(b.if(gender,age)) return { low:(b.low??null), high:(b.high??null), note:(b.note||'') }; }
      return {low:null,high:null,note:''};
    }

    // Build Form
    function loadForm(){
      const tKey = state.selectedTest;
      const test = TESTS[tKey];
      el.formHeading.textContent = `Form ‚Äî ${test?test.title:''}`;
      el.sel_test.value = test?test.title:'';
      el.sel_patient.value = `${state.patient.name||'-'} ‚Ä¢ ${state.patient.age||'-'}y ${state.patient.gender||'-'} ‚Ä¢ Reg:${state.patient.id||'-'}`;

      // table
      el.paramsArea.innerHTML='';
      if(!test){ el.paramsArea.innerHTML='<div class="notice">No test selected.</div>'; return; }
      const table=document.createElement('table');
      table.innerHTML='<thead><tr><th>Parameter</th><th>Normal Range</th><th>Value</th><th>Unit</th><th>Flag</th></tr></thead>';
      const tbody=document.createElement('tbody');

      test.params.forEach((p,idx)=>{
        const r=resolveRange(p, state.patient.gender, state.patient.age);
        const tr=document.createElement('tr');
        const rangeTxt=(r.low!=null&&r.high!=null)? `${r.low} - ${r.high}${p.unit?(' '+p.unit):''}` : (p.normalText? p.normalText : '‚Äî');
        const key=p.key; const val=(state.values[tKey]||{})[key] ?? '';
        const inputId=`inp_${tKey}_${idx}`;
        let inputHtml='';
        if(p.ro){
          inputHtml = `<input id="${inputId}" data-idx="${idx}" data-key="${key}" disabled placeholder="auto" value="${val}" />`;
        } else if(p.type==='select'){
          const opts=(p.options||[]).map(o=>`<option ${String(val)===String(o)?'selected':''}>${o}</option>`).join('');
          inputHtml = `<select id="${inputId}" data-idx="${idx}" data-key="${key}">${opts}</select>`;
        } else if(p.type==='text'){
          inputHtml = `<input id="${inputId}" data-idx="${idx}" data-key="${key}" placeholder="enter" value="${val}" />`;
        } else {
          inputHtml = `<input id="${inputId}" type="number" step="0.01" data-idx="${idx}" data-key="${key}" placeholder="0" value="${val}" />`;
        }
        tr.innerHTML = `<td>${p.label||p.key}</td><td class="small">${rangeTxt}${r.note?` <span class='subtle'>(${r.note})</span>`:''}</td><td>${inputHtml}</td><td>${p.unit||''}</td><td><span id="flag_${tKey}_${idx}"></span></td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody); el.paramsArea.appendChild(table);

      // bind inputs
      test.params.forEach((p,idx)=>{
        const inp=document.getElementById(`inp_${tKey}_${idx}`);
        if(!inp) return;
        inp.addEventListener('input',()=>{ onValueChange(tKey, idx); });
      });

      // compute once on load
      recalcComputed(); refreshPreview();
    }

    function onValueChange(tKey, idx){
      const test=TESTS[tKey]; if(!test) return; const p=test.params[idx]; const inp=document.getElementById(`inp_${tKey}_${idx}`); if(!p||!inp) return;
      const raw = (p.type==='select'||p.type==='text')? inp.value : (inp.value===''? '' : Number(inp.value));
      state.values[tKey] = state.values[tKey] || {}; state.values[tKey][p.key]=raw; saveState();
      // recompute dependents if any
      recalcComputed();
      // set flag for edited param
      setFlagFor(tKey, idx);
      refreshPreview();
    }

    function recalcComputed(){
      const tKey = state.selectedTest; const test = TESTS[tKey]; if(!test) return;
      const vals = state.values[tKey]||{};
      test.params.forEach((p,idx)=>{
        if(p.compute){ const v = p.compute(vals); const elInp=document.getElementById(`inp_${tKey}_${idx}`); if(elInp){ elInp.value=(v===''? '' : v); } vals[p.key]=v; setFlagFor(tKey, idx); }
      });
      state.values[tKey]=vals; saveState();
    }

    function setFlagFor(tKey, idx){
      const test=TESTS[tKey]; if(!test) return; const p=test.params[idx]; const flagSpan=document.getElementById(`flag_${tKey}_${idx}`); if(!flagSpan) return;
      const r=resolveRange(p, state.patient.gender, state.patient.age);
      if(p.type==='select' || p.type==='text'){ // qualitative
        const val = (state.values[tKey]||{})[p.key];
        if(val==null||val===''){ flagSpan.innerHTML=''; return; }
        if(p.normalText){ flagSpan.innerHTML = (String(val).toLowerCase()===String(p.normalText).toLowerCase())? '<span class="flag normal">Normal</span>' : '<span class="flag high">Abnormal</span>'; }
        else flagSpan.innerHTML='';
        return;
      }
      const val = parseFloat((state.values[tKey]||{})[p.key]);
      if(isNaN(val)){ flagSpan.innerHTML=''; return; }
      if(r.low==null||r.high==null){ flagSpan.innerHTML=''; return; }
      if(val<r.low) flagSpan.innerHTML='<span class="flag low">Low</span>';
      else if(val>r.high) flagSpan.innerHTML='<span class="flag high">High</span>';
      else flagSpan.innerHTML='<span class="flag normal">Normal</span>';
    }

    // Preview renderer
    function refreshPreview(){
      const p=state.patient; const tKey=state.selectedTest; const test=TESTS[tKey];
      el.rep_date.innerText = (p.date|| new Date().toISOString().slice(0,10));
      el.rep_patient.innerText = `Patient: ${p.name||'-'}`;
      el.rep_age.innerText = `Age: ${p.age||'-'}`;
      el.rep_gender.innerText = `Gender: ${p.gender||'-'}`;
      el.rep_id.innerText = `Reg. No: ${p.id||'-'}`;
      el.rep_test.innerText = `Test: ${test?test.title:'-'}`;
      el.rep_ref.innerText = `Ref. By: ${p.ref||'-'}`;

      if(!test){ el.resultTableHolder.innerHTML='<div class="legend">Select a test & enter values‚Ä¶</div>'; document.getElementById('sectionTitle').innerText=''; return; }

      document.getElementById('sectionTitle').innerText = test.title;
      const vals = state.values[tKey]||{};
      let html = `<table><thead><tr>${test.columns.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>`;
      test.params.forEach((p,idx)=>{
        const r=resolveRange(p, p.skipGender?null:state.patient.gender, state.patient.age);
        const value = (p.type==='select'||p.type==='text')? (vals[p.key]??'') : (vals[p.key]??'');        
        const showVal = (value===undefined||value==='')? '' : value;
        const flagSpanId = `flag_${tKey}_${idx}`;
        let rangeText = (r.low!=null&&r.high!=null)? `${r.low} - ${r.high}` : (p.normalText? p.normalText : '‚Äî');
        html += `<tr>
          <td>${p.label||p.key}</td>
          <td>${showVal}</td>
          <td>${p.unit||''}</td>
          <td class="small">${rangeText}${p.unit?(' '+p.unit):''}${r.note?` <span class='subtle'>(${r.note})</span>`:''}</td>
          <td><span id='${flagSpanId}'>${document.getElementById(flagSpanId)?document.getElementById(flagSpanId).innerHTML:''}</span></td>
        </tr>`;
      });
      html += '</tbody></table>';
      el.resultTableHolder.innerHTML = html;
      // after rewrite, recompute flags to ensure preview updated
      const t=TESTS[tKey]; if(t){ t.params.forEach((_,i)=>setFlagFor(tKey,i)); }
    }

    // ====================== PDF Download ===================================
    document.getElementById('downloadPdf').addEventListener('click',()=>{
      const element=document.getElementById('reportPreview');
      const opt={margin:10,filename:(state.patient.name||'report')+'.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
      if(typeof html2pdf==='undefined'){
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js';
        s.onload=()=>html2pdf().set(opt).from(element).save();
        document.body.appendChild(s);
      } else html2pdf().set(opt).from(element).save();
    });

    // ====================== NAV & EVENTS ===================================
    el.btnHome.onclick=()=>{ show('home'); };
    el.btnForm.onclick=()=>{ show('form'); };
    el.btnReset.onclick=()=>{ if(confirm('Reset all saved data?')) resetState(); };

    el.saveOnly.onclick=()=>{ saveHome(); alert('Saved'); };
    el.saveProceed.onclick=()=>{ saveHome(); show('form'); loadForm(); };
    el.backToHome.onclick=()=>{ show('home'); };

    el.fillExample.onclick=()=>{
      const tKey=state.selectedTest; const test=TESTS[tKey]; if(!test) return;
      state.values[tKey]=state.values[tKey]||{};
      // very light demo values (safe defaults)
      test.params.forEach(p=>{
        if(p.ro) return; if(p.type==='select'){ state.values[tKey][p.key]= (p.normalText|| (p.options?p.options[0]:'-')); }
        else if(p.type==='text'){ state.values[tKey][p.key]= p.normalText||''; }
        else { // numeric
          const r=resolveRange(p, state.patient.gender, state.patient.age);
          if(r.low!=null&&r.high!=null){ state.values[tKey][p.key]= round((r.low+r.high)/2); }
        }
      });
      saveState(); loadForm(); refreshPreview();
    };

    el.clearValues.onclick=()=>{ const tKey=state.selectedTest; if(!tKey) return; state.values[tKey] = {}; saveState(); loadForm(); };

    // ====================== INIT ===========================================
    document.addEventListener('DOMContentLoaded',()=>{
      loadHome(); refreshPreview();
      // if already selected test & values exist, show form
      if(state.selectedTest){ show('form'); loadForm(); }
      else show('home');
    });
  </script>
</body>
</html>
