<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathology Lab Report Generator</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #1a1a1a;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        /* Form and Input Section */
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .input-fields-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .input-fields-row .form-group {
            flex: 1 1 250px;
        }

        .print-button {
            display: block;
            width: 250px;
            margin: 30px auto;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease;
        }

        .print-button:hover {
            background-color: #0056b3;
        }

        .live-preview {
            border-top: 1px dashed #ccc;
            padding-top: 20px;
            margin-top: 20px;
        }

        /* Report Section */
        .report-content {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .lab-header {
            text-align: center;
            line-height: 1.2;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .lab-header h1 {
            margin: 0;
            font-size: 28px;
            color: #004d99;
        }

        .lab-header p {
            margin: 2px 0 0;
            font-size: 14px;
            color: #555;
        }

        .patient-info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .patient-info-table td {
            padding: 5px;
            border-bottom: 1px dashed #ccc;
        }

        .patient-info-table td:first-child {
            width: 150px;
            font-weight: bold;
        }

        .test-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .test-report-table th,
        .test-report-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 14px;
        }

        .test-report-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .abnormal-result {
            color: red;
            font-weight: bold;
        }

        .report-footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 12px;
            text-align: center;
        }

        .report-footer p {
            margin: 5px 0;
        }

        .report-remarks {
            margin-top: 20px;
            font-size: 14px;
        }

        .report-remarks h4 {
            margin-bottom: 5px;
        }

        .authorized-signatory {
            margin-top: 40px;
            text-align: right;
        }

        .authorized-signatory .line {
            width: 150px;
            height: 1px;
            background: #000;
            margin-left: auto;
            margin-bottom: 5px;
        }

        .authorized-signatory p {
            margin: 0;
            font-size: 12px;
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: #fff;
                font-size: 12pt;
                -webkit-print-color-adjust: exact;
            }

            .container {
                box-shadow: none;
                padding: 0;
                border-radius: 0;
                width: 100%;
                max-width: 100%;
                margin: 0;
            }

            .form-section,
            .print-button {
                display: none;
            }

            .live-preview {
                display: block !important;
                border: none;
                padding: 0;
                page-break-after: always;
            }

            .report-content {
                border: none;
                padding: 0;
            }

            .lab-header,
            .patient-info-table,
            .test-report-table,
            .report-footer {
                padding: 10px 0;
            }

            .lab-header {
                border-bottom: 2px solid #000;
            }

            .lab-header h1 {
                font-size: 24px;
            }

            .lab-header p {
                font-size: 12px;
            }

            .patient-info-table td {
                padding: 1%;
                border-bottom: 1px dashed #000;
                font-size: 12px;
            }

            .test-report-table th,
            .test-report-table td {
                border-color: #000;
                font-size: 12px;
                padding: 8px;
            }

            .report-footer {
                border-top: 1px solid #000;
                font-size: 10px;
            }
        }
    </style>
</head>

<body ng-app="reportApp" ng-controller="ReportController">

    <div class="container">
        <div class="form-section">
            <h2>Pathology Lab Report Generator</h2>

            <h3>Patient Information</h3>
            <div class="input-fields-row">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" ng-model="patient.name" placeholder="Patient's Name">
                </div>
                <div class="form-group">
                    <label for="age">Age:</label>
                    <input type="number" id="age" ng-model="patient.age" placeholder="Age" min="0">
                </div>
                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" ng-model="patient.gender">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sampleId">Sample ID:</label>
                    <input type="text" id="sampleId" ng-model="patient.sampleId" placeholder="Sample ID">
                </div>
                <div class="form-group">
                    <label for="sampleDate">Sample Date:</label>
                    <input type="date" id="sampleDate" ng-model="patient.sampleDate">
                </div>
            </div>

            <h3>Select Test & Enter Results</h3>
            <div class="input-fields-row">
                <div class="form-group">
                    <label for="testSelect">Test:</label>
                    <select id="testSelect" ng-model="selectedTest" ng-change="loadTestParameters()">
                        <option value="">Select a Test</option>
                        <option ng-repeat="test in testList" value="{{test.id}}">{{test.name}}</option>
                    </select>
                </div>
            </div>

            <div class="input-fields-row" ng-show="selectedTest && testParameters.length > 0">
                <div class="form-group" ng-repeat="param in testParameters">
                    <label>{{param.name}} ({{param.units}}):</label>
                    <input type="text" ng-model="param.value" ng-change="flagAbnormal(param)" placeholder="Result">
                    <small ng-if="param.normalRange">
                        Normal Range: {{param.normalRange}}
                    </small>
                </div>
            </div>
            <button class="print-button" ng-click="printReport()">Print / Save as PDF</button>
        </div>

        <div class="live-preview" ng-show="selectedTest">
            <div class="report-content">
                <div class="lab-header">
                    <h1>ðŸ”¬YASH PATHLAB</h1>
                    <p>Chondi, Barbaspur, Anuppur - 484336</p>
                    <p>Contact: +91 7879619498 | Email: ukumar.kewat5@gmail.com</p>
                </div>

                <table class="patient-info-table">
                    <tr>
                        <td>Patient Name</td>
                        <td>: {{patient.name || 'N/A'}}</td>
                        <td>Report Date</td>
                        <td>: {{patient.reportDate | date:'dd-MM-yyyy'}}</td>
                    </tr>
                    <tr>
                        <td>Age / Gender</td>
                        <td>: {{patient.age || 'N/A'}} years / {{patient.gender || 'N/A'}}</td>
                        <td>Sample ID</td>
                        <td>: {{patient.sampleId || 'N/A'}}</td>
                    </tr>
                    <tr>
                        <td>Referring Doctor</td>
                        <td>:_______________</td>
                        <td>Sample Date</td>
                        <td>: {{patient.sampleDate | date:'dd-MM-yyyy'}}</td>
                    </tr>
                </table>

                <h3 style="text-align: center; margin-bottom: 20px; font-weight: bold;">{{getTestName()}} REPORT</h3>

                <table class="test-report-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Parameter</th>
                            <th style="width: 20%;">Result</th>
                            <th style="width: 15%;">Unit</th>
                            <th style="width: 25%;">Biological Reference Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="param in testParameters">
                            <td>{{param.name}}</td>
                            <td ng-class="{'abnormal-result': param.isAbnormal}">{{param.value}}</td>
                            <td>{{param.units}}</td>
                            <td>{{param.normalRange}}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="report-remarks">
                    <h4>Remarks:</h4>
                    <p>- The results provided are for reference only and are not a substitute for a physician's opinion.
                    </p>
                    <p>- Normal ranges may vary slightly based on the laboratory.</p>
                </div>

                <div class="authorized-signatory">
                    <div class="line"></div>
                    <p>Authorized Signatory</p>
                </div>

                <div class="report-footer">
                    <p>--- End of Report ---</p>
                    <p>This is a computer-generated report and does not require a signature.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        var app = angular.module('reportApp', []);

        app.controller('ReportController', function ($scope) {
            $scope.patient = {
                name: '',
                age: null,
                gender: '',
                address: '',
                sampleId: '',
                sampleDate: new Date(),
                reportDate: new Date()
            };

            $scope.selectedTest = '';
            $scope.testParameters = [];

            // JSON Data for Tests and Parameters
            var testsData = {
                "cbc": {
                    "name": "CBC (Complete Blood Count)",
                    "parameters": {
                        "Hemoglobin": { "units": "g/dL", "ranges": { "Male": [13, 18], "Female": [12, 16] } },
                        "RBC Count": { "units": "Ã—10^6/Î¼L", "ranges": { "Male": [4.6, 6.2], "Female": [4.2, 5.4] } },
                        "Hematocrit / PCV": { "units": "%", "ranges": { "Male": [40, 54], "Female": [36, 48] } },
                        "MCV (Mean Corpuscular Volume)": { "units": "fL", "ranges": { "Adults": [80, 100] } },
                        "MCH (Mean Corpuscular Hemoglobin)": { "units": "pg", "ranges": { "Adults": [27, 33] } },
                        "MCHC (Mean Corpuscular Hemoglobin Concentration)": { "units": "g/dL", "ranges": { "Adults": [32, 36] } },
                        "RDW (Red Cell Distribution Width)": { "units": "%", "ranges": { "Adults": [11.5, 14.5] } },
                        "Total Leucocyte Count (TLC/WBC)": { "units": "Ã—10^3/Î¼L", "ranges": { "Adults": [4.5, 11] } },
                        "Neutrophils": { "units": "%", "ranges": { "Adults": [40, 70] } },
                        "Lymphocytes": { "units": "%", "ranges": { "Adults": [20, 40] } },
                        "Monocytes": { "units": "%", "ranges": { "Adults": [2, 8] } },
                        "Eosinophils": { "units": "%", "ranges": { "Adults": [1, 6] } },
                        "Basophils": { "units": "%", "ranges": { "Adults": [0, 2] } },
                        "Platelet Count": { "units": "Ã—10^3/Î¼L", "ranges": { "Adults": [150, 400] } },
                        "MPV (Mean Platelet Volume)": { "units": "fL", "ranges": { "Adults": [7.5, 11.5] } },
                        "PDW (Platelet Distribution Width)": { "units": "%", "ranges": { "Adults": [9, 14] } },
                        "Immature Granulocyte (IG)": { "units": "%", "ranges": { "Adults": [0, 0.4] } },
                        "Nucleated RBC (NRBC)": { "units": "per 100 WBC", "ranges": { "Adults": [0, 0] } }
                    }
                },
                "kft": {
                    "name": "KFT (Kidney Function Test)",
                    "parameters": {
                        "Serum Creatinine": { "units": "mg/dL", "ranges": { "Male": [0.7, 1.3], "Female": [0.6, 1.1] } },
                        "Blood Urea Nitrogen (BUN)": { "units": "mg/dL", "ranges": { "Adults": [7, 20] } },
                        "Serum Uric Acid": { "units": "mg/dL", "ranges": { "Male": [3.5, 7.2], "Female": [2.6, 6.0] } },
                        "Sodium (Na+)": { "units": "mEq/L", "ranges": { "Adults": [135, 145] } },
                        "Potassium (K+)": { "units": "mEq/L", "ranges": { "Adults": [3.5, 5.0] } },
                        "Chloride (Cl-)": { "units": "mEq/L", "ranges": { "Adults": [98, 107] } },
                        "Bicarbonate (HCO3-)": { "units": "mEq/L", "ranges": { "Adults": [22, 28] } },
                        "eGFR (Estimated Glomerular Filtration Rate)": { "units": "mL/min/1.73mÂ²", "ranges": { "Adults": [90, 120] }, "is_gfr": true }
                    }
                },
                "lft": {
                    "name": "LFT (Liver Function Test)",
                    "parameters": {
                        "Total Bilirubin": { "units": "mg/dL", "ranges": { "Adults": [0.1, 1.2] } },
                        "SGOT (AST)": { "units": "U/L", "ranges": { "Adults": [8, 40] } },
                        "SGPT (ALT)": { "units": "U/L", "ranges": { "Adults": [7, 56] } },
                        "Alkaline Phosphatase": { "units": "U/L", "ranges": { "Adults": [40, 150] } }
                    }
                },
                "lipid_profile": {
                    "name": "Lipid Profile",
                    "parameters": {
                        "Total Cholesterol": { "units": "mg/dL", "ranges": { "Adults": [125, 200] } },
                        "Triglycerides": { "units": "mg/dL", "ranges": { "Adults": [0, 150] } },
                        "HDL Cholesterol": { "units": "mg/dL", "ranges": { "Male": [40, 60], "Female": [50, 60] } },
                        "LDL Cholesterol": { "units": "mg/dL", "ranges": { "Adults": [0, 100] } },
                        "VLDL Cholesterol": { "units": "mg/dL", "ranges": { "Adults": [5, 40] } },
                        "Total Cholesterol/HDL Ratio": { "units": "Ratio", "ranges": { "Adults": [0, 4.5] } },
                        "LDL/HDL Ratio": { "units": "Ratio", "ranges": { "Adults": [0, 3] } }
                    }
                },
                "blood_glucose": {
                    "name": "Blood Glucose",
                    "parameters": {
                        "Fasting Blood Sugar (FBS)": { "units": "mg/dL", "ranges": { "Adults": [70, 100] } },
                        "Post Prandial Blood Sugar (PPBS)": { "units": "mg/dL", "ranges": { "Adults": [70, 140] } },
                        "HbA1c": { "units": "%", "ranges": { "Adults": [4, 5.6] } }
                    }
                },
                "thyroid_profile": {
                    "name": "Thyroid Profile",
                    "parameters": {
                        "TSH": { "units": "Î¼IU/mL", "ranges": { "Adults": [0.4, 4.0] } },
                        "Free T4": { "units": "ng/dL", "ranges": { "Adults": [0.8, 1.8] } },
                        "Free T3": { "units": "pg/mL", "ranges": { "Adults": [2.3, 4.2] } }
                    }
                },
                "widal": {
                    "name": "Widal Test",
                    "parameters": {
                        "S. typhi O antigen": { "units": "Titre", "normalTiterValue": 80, "normalTiterText": "<1:80", "positiveTiterText": "â‰¥1:160" },
                        "S. typhi H antigen": { "units": "Titre", "normalTiterValue": 160, "normalTiterText": "<1:160", "positiveTiterText": "â‰¥1:160" },
                        "S. paratyphi A H antigen": { "units": "Titre", "normalTiterValue": 160, "normalTiterText": "<1:160", "positiveTiterText": "â‰¥1:160" },
                        "S. paratyphi B H antigen": { "units": "Titre", "normalTiterValue": 160, "normalTiterText": "<1:160", "positiveTiterText": "â‰¥1:160" }
                    }
                }
            };

            $scope.testList = Object.keys(testsData).map(key => ({ id: key, name: testsData[key].name }));

            $scope.loadTestParameters = function () {
                if (!$scope.selectedTest) {
                    $scope.testParameters = [];
                    return;
                }
                const test = testsData[$scope.selectedTest];
                const newParams = [];
                for (let paramName in test.parameters) {
                    const param = test.parameters[paramName];
                    const range = $scope.getNormalRange(paramName, param);
                    newParams.push({
                        name: paramName,
                        units: param.units,
                        value: '',
                        isAbnormal: false,
                        normalRange: range
                    });
                }
                $scope.testParameters = newParams;
            };

            $scope.getNormalRange = function (paramName, param) {
                if (param.units === "Titre") {
                    return param.normalTiterText;
                }
                if (param.is_gfr) {
                    return "â‰¥90";
                }
                const gender = $scope.patient.gender;
                const ranges = param.ranges;
                const relevantRanges = ranges[gender] || ranges["Adults"] || ranges["Male"] || ranges["Female"];
                if (Array.isArray(relevantRanges)) {
                    return `${relevantRanges[0]} - ${relevantRanges[1]}`;
                }
                return relevantRanges || 'N/A';
            };

            $scope.flagAbnormal = function (param) {
                const enteredValue = param.value;
                if (!enteredValue) {
                    param.isAbnormal = false;
                    return;
                }

                const testData = testsData[$scope.selectedTest];
                const paramData = testData.parameters[param.name];

                if (param.units === "Titre") {
                    const lowerCaseValue = enteredValue.toLowerCase().trim();
                    if (lowerCaseValue.includes("negative")) {
                        param.isAbnormal = false;
                        return;
                    }

                    const match = enteredValue.match(/^1:(\d+)$/);
                    if (match) {
                        const titerValue = parseInt(match[1], 10);
                        const normalThreshold = paramData.normalTiterValue;
                        if (titerValue >= normalThreshold) {
                            param.isAbnormal = true;
                        } else {
                            param.isAbnormal = false;
                        }
                    } else {
                        param.isAbnormal = true; // Flag if format is incorrect
                    }
                } else if (param.is_gfr) {
                    const value = parseFloat(enteredValue);
                    if (isNaN(value) || value <= 90) {
                        param.isAbnormal = true;
                    } else {
                        param.isAbnormal = false;
                    }
                } else {
                    // Logic for numeric values
                    const relevantRanges = paramData.ranges;
                    const relevantRange = relevantRanges[$scope.patient.gender] || relevantRanges["Adults"] || relevantRanges["Male"] || relevantRanges["Female"];

                    if (!relevantRange || !Array.isArray(relevantRange)) {
                        param.isAbnormal = false;
                        return;
                    }

                    const lower = relevantRange[0];
                    const upper = relevantRange[1];
                    const value = parseFloat(enteredValue);

                    if (isNaN(value)) {
                        param.isAbnormal = false;
                        return;
                    }

                    if (value < lower || value > upper) {
                        param.isAbnormal = true;
                    } else {
                        param.isAbnormal = false;
                    }
                }
            };

            $scope.getTestName = function () {
                const test = testsData[$scope.selectedTest];
                return test ? test.name : '';
            };

            $scope.printReport = function () {
                window.print();
            };
        });
    </script>
</body>

</html>
