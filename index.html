<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Pathology Lab Report Generator</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
            body {
            font-family: 'Poppins', sans-serif;
            background-color: #F5F5F5;
            color: #424242;
            }
            .lab-header {
            background-color: #1A237E;
            color: white;
            padding: 1.5rem 0;
            border-bottom: 5px solid #42A5F5;
            }
            .lab-logo {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            }
            .card {
            border-radius: 0.75rem;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            border: none;
            }
            .report-preview {
            position: sticky;
            top: 1.5rem;
            height: calc(100vh - 3rem);
            overflow-y: auto;
            }
            .report-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            .value-low {
            color: #42A5F5;
            font-weight: 600;
            }
            .value-high {
            color: #EF5350;
            font-weight: 600;
            }
            .table th {
            background-color: #E0E0E0;
            color: #212121;
            }
            .table thead {
            border-bottom: 2px solid #bdbdbd;
            }
            .form-control, .form-select {
            border-radius: 0.5rem;
            border: 1px solid #E0E0E0;
            transition: all 0.2s;
            }
            .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(66, 165, 245, 0.25);
            border-color: #42A5F5;
            }
            .btn-primary {
            background-color: #1A237E;
            border-color: #1A237E;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
            }
            .btn-primary:hover {
            background-color: #283593;
            transform: translateY(-2px);
            }
            .btn-secondary {
            background-color: #757575;
            border-color: #757575;
            font-weight: 600;
            }
            .btn-secondary:hover {
            background-color: #616161;
            }
            .btn-outline-secondary {
            border-color: #9E9E9E;
            color: #616161;
            }
            .btn-outline-secondary:hover {
            background-color: #e0e0e0;
            color: #424242;
            }
            footer {
            margin-top: 3rem;
            padding: 2rem 0;
            text-align: center;
            font-size: 0.8rem;
            color: #6c757d;
            border-top: 1px solid #e0e0e0;
            }
            @media (max-width: 991.98px) {
            .report-preview {
            position: static;
            height: auto;
            margin-top: 1.5rem;
            }
            }
            @media print {
            body { background: white !important; }
            #footnote{ display: none !important; }
            .lab-header { 
            position: static !important; 
            background: #1A237E !important; 
            color: white !important; 
            border-bottom: 5px solid #42A5F5 !important;
            }
            main .row > .col-lg-7 { display: none !important; }
            main .row > .col-lg-5 { 
            flex: 0 0 100% !important; 
            max-width: 100% !important; 
            width: 100% !important;
            }
            .report-preview { 
            position: static !important; 
            height: auto !important; 
            top: auto !important;
            }
            #previewContent { 
            box-shadow: none !important; 
            border: none !important; 
            padding: 1rem !important;
            background: white !important;
            }
            footer { 
            position: static !important; 
            border-top: 1px solid #e0e0e0 !important; 
            color: #6c757d !important;
            page-break-inside: avoid;
            }
            .table { 
            font-size: 10pt !important; 
            width: 100% !important;
            }
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    </head>
    <body>
        <header class="lab-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="lab-logo">🔬 Yash Pathlab</div>
                    <div class="text-end">
                        <small>
                        Chodi, Barbaspur, Anuppur (M.P.) 484336<br>
                        📞 7879619498 • ukumar.kewat5@gmail.com
                        </small>
                    </div>
                </div>
            </div>
        </header>
        <main class="container my-2">
            <div class="row g-5">
                <div class="col-lg-7">
                    <div class="card p-4" id="patientDetailsPanel">
                        <h5 class="card-title mb-4">Patient Details & Test Selection</h5>
                        <div id="alertPlaceholder" class="mb-3"></div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="p_name" class="form-label">Patient Name</label>
                                <input type="text" id="p_name" class="form-control" placeholder="Enter name" required />
                            </div>
                            <div class="col-md-6">
                                <label for="p_id" class="form-label">Patient ID / Reg. No.</label>
                                <input type="text" id="p_id" class="form-control" placeholder="ID / MRN" />
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="p_age" class="form-label">Age (Years)</label>
                                <input type="number" id="p_age" class="form-control" min="0" placeholder="e.g., 35" required />
                            </div>
                            <div class="col-md-6">
                                <label for="p_gender" class="form-label">Gender</label>
                                <select id="p_gender" class="form-select">
                                    <option value="">-- Select Gender --</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="p_date" class="form-label">Sample Collection Date</label>
                                <input type="date" id="p_date" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label for="p_test" class="form-label">Select Test(s)</label>
                                <select id="p_test" class="form-select" multiple required>
                                    <option value="CBC">CBC — Complete Blood Count</option>
                                    <option value="LFT">LFT — Liver Function Test</option>
                                    <option value="KFT">KFT — Kidney/Renal Function Test</option>
                                    <option value="LIPID">Lipid Profile</option>
                                    <option value="TFT">Thyroid Function (TFT)</option>
                                    <option value="GLU">Glucose Panel</option>
                                    <option value="ELEC">Electrolytes</option>
                                    <option value="URINE">Urine R/E</option>
                                    <option value="IRON">Iron Studies</option>
                                    <option value="INFL">Inflammatory Markers (CRP/ESR)</option>
                                    <option value="MAL">Malaria Test</option>
                                    <option value="TYPH">Typhoid (Widal)</option>
                                    <option value="HBSAG">HBsAg</option>
                                    <option value="VITB12">Vitamin B12</option>
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple.</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="p_ref" class="form-label">Referring Doctor / Clinic (Optional)</label>
                            <input type="text" id="p_ref" class="form-control" placeholder="Doctor's Name, Clinic" />
                        </div>
                        <div class="d-flex gap-2 mt-4">
                            <button id="saveProceed" class="btn btn-primary">Proceed to Form &rarr;</button>
                        </div>
                    </div>
                    <div class="card p-4 mt-4 d-none" id="panelForm">
                        <h5 class="card-title" id="formHeading">Enter Values</h5>
                        <div id="paramsArea"></div>
                        <div class="d-flex gap-2 mt-4">
                            <button id="downloadPdf" class="btn btn-primary">⬇ Download PDF</button>
                            <button id="printReport" class="btn btn-success">🖨 Print Report</button>
                            <button id="backToHome" class="btn btn-secondary">← Back</button>
                            <button id="clearValues" class="btn btn-outline-secondary">Clear Values</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="report-preview">
                        <div class="report-card" id="previewContent">
                            <p class="text-muted text-center">Your report preview will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer>
            <div class="container text-center">
                <div id="footnote">
                    <p>© 2025 Yash Pathlab. All rights reserved.</p>
                    <p class="mt-2">Developed by: Aniket Ram Kewat | 📞 +91 6266562082 | ✉️ aniket07r+pathlab@gmail.com</p>
                </div>
            </div>
        </footer>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        
                                                    function round(n){ return (n||n===0)? Math.round(n*100)/100 : '' }
          <script>
    	
    	     // Data and Logic
        const TESTS = {
            "CBC": {
                title: "Complete Blood Count",
                params: [
                    { key: "Hemoglobin", unit: "g/dL", low: 13.5, high: 17.5, refMale: [13.5, 17.5], refFemale: [12.0, 15.5] },
                    { key: "RBC", unit: "million/µL", low: 4.5, high: 5.9, refMale: [4.5, 5.9], refFemale: [4.1, 5.1] },
                    { key: "WBC", unit: "thousand/µL", low: 4.0, high: 11.0 },
                    { key: "Platelets", unit: "thousand/µL", low: 150, high: 450 },
                    { key: "PCV (HCT)", unit: "%", low: 40, high: 54, refMale: [40, 54], refFemale: [36, 48] },
                    { key: "MCV", unit: "fL", low: 80, high: 100 },
                    { key: "MCH", unit: "pg", low: 27, high: 33 },
                    { key: "MCHC", unit: "g/dL", low: 32, high: 36 },
                    { key: "RDW-CV", unit: "%", low: 11.5, high: 14.5 },
                    { key: "Neutrophils", unit: "%", low: 40, high: 75 },
                    { key: "Lymphocytes", unit: "%", low: 20, high: 45 },
                    { key: "Eosinophils", unit: "%", low: 1, high: 6 },
                    { key: "Monocytes", unit: "%", low: 2, high: 10 },
                    { key: "Basophils", unit: "%", low: 0, high: 2 }
                ]
            },
            "LFT": {
                title: "Liver Function Test",
                params: [
                    { key: "Total Bilirubin", unit: "mg/dL", low: 0.1, high: 1.2 },
                    { key: "Direct Bilirubin", unit: "mg/dL", low: 0, high: 0.3 },
                    { key: "Indirect Bilirubin", unit: "mg/dL", ro: true },
                    { key: "SGOT (AST)", unit: "U/L", low: 8, high: 48 },
                    { key: "SGPT (ALT)", unit: "U/L", low: 7, high: 55 },
                    { key: "Alkaline Phosphatase (ALP)", unit: "U/L", low: 44, high: 147 },
                    { key: "Total Protein", unit: "g/dL", low: 6.0, high: 8.3 },
                    { key: "Albumin", unit: "g/dL", low: 3.5, high: 5.0 },
                    { key: "Globulin", unit: "g/dL", ro: true },
                    { key: "A/G Ratio", unit: "", ro: true }
                ]
            },
            "KFT": {
                title: "Kidney Function Test",
                params: [
                    { key: "Urea", unit: "mg/dL", low: 17, high: 43 },
                    { key: "Creatinine", unit: "mg/dL", low: 0.6, high: 1.3, refMale: [0.6, 1.3], refFemale: [0.5, 1.1] },
                    { key: "Uric Acid", unit: "mg/dL", low: 3.4, high: 7.0, refMale: [3.4, 7.0], refFemale: [2.4, 6.0] },
                    { key: "BUN", unit: "mg/dL", low: 6, high: 24 },
                    { key: "BUN/Creatinine Ratio", unit: "", ro: true },
                    { key: "Na (Sodium)", unit: "mmol/L", low: 135, high: 145 },
                    { key: "K (Potassium)", unit: "mmol/L", low: 3.5, high: 5.1 },
                    { key: "Cl (Chloride)", unit: "mmol/L", low: 98, high: 107 }
                ]
            },
            "LIPID": {
                title: "Lipid Profile",
                params: [
                    { key: "Total Cholesterol", unit: "mg/dL", low: 0, high: 200 },
                    { key: "HDL Cholesterol", unit: "mg/dL", low: 40, high: 60, refMale: [40, 60], refFemale: [50, 60] },
                    { key: "LDL Cholesterol", unit: "mg/dL", low: 0, high: 100 },
                    { key: "Triglycerides", unit: "mg/dL", low: 0, high: 150 },
                    { key: "VLDL Cholesterol", unit: "mg/dL", ro: true },
                    { key: "Non-HDL Cholesterol", unit: "mg/dL", ro: true }
                ]
            },
            "TFT": {
                title: "Thyroid Function Test",
                params: [
                    { key: "T3 (Total)", unit: "ng/dL", low: 80, high: 200 },
                    { key: "T4 (Total)", unit: "µg/dL", low: 4.5, high: 12.0 },
                    { key: "TSH", unit: "µIU/mL", low: 0.4, high: 4.2 }
                ]
            },
            "GLU": {
                title: "Glucose Panel",
                params: [
                    { key: "Glucose (Fasting)", unit: "mg/dL", low: 70, high: 100 },
                    { key: "Glucose (PP)", unit: "mg/dL", low: 70, high: 140 },
                    { key: "Random Glucose", unit: "mg/dL", low: 70, high: 140 },
                    { key: "HbA1c", unit: "%", low: 4.0, high: 5.6 }
                ]
            },
            "ELEC": {
                title: "Electrolytes",
                params: [
                    { key: "Sodium (Na+)", unit: "mmol/L", low: 135, high: 145 },
                    { key: "Potassium (K+)", unit: "mmol/L", low: 3.5, high: 5.1 },
                    { key: "Chloride (Cl-)", unit: "mmol/L", low: 98, high: 107 },
                    { key: "Calcium (Ca++)", unit: "mg/dL", low: 8.5, high: 10.2 }
                ]
            },
            "URINE": {
                title: "Urine R/E",
                params: [
                    { key: "Color", unit: "", type: "select", options: ["Light Yellow", "Dark Yellow", "Amber", "Red", "Brown", "Colorless"], normalText: "Light Yellow" },
                    { key: "Appearance", unit: "", type: "select", options: ["Clear", "Slightly Cloudy", "Cloudy", "Turbid"], normalText: "Clear" },
                    { key: "pH", unit: "", low: 4.5, high: 8.0, normalText: "6.0" },
                    { key: "Specific Gravity", unit: "", low: 1.003, high: 1.030, normalText: "1.010" },
                    { key: "Glucose", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                    { key: "Proteins", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                    { key: "Ketones", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                    { key: "Blood", unit: "", type: "select", options: ["Negative", "Trace", "+1", "+2", "+3", "+4"], normalText: "Negative" },
                    { key: "Microscopic Exam", unit: "", type: "textarea", normalText: "Epithelial cells: 2-3 / HPF" }
                ]
            },
            "IRON": {
                title: "Iron Studies",
                params: [
                    { key: "Serum Iron", unit: "µg/dL", low: 50, high: 150 },
                    { key: "Total Iron Binding Capacity", unit: "µg/dL", low: 250, high: 450 },
                    { key: "Ferritin", unit: "ng/mL", low: 20, high: 300, refMale: [20, 300], refFemale: [20, 150] }
                ]
            },
            "INFL": {
                title: "Inflammatory Markers",
                params: [
                    { key: "C-Reactive Protein (CRP)", unit: "mg/L", high: 5.0, low: 0, normalText: "Normal" },
                    { key: "ESR (Westergren)", unit: "mm/hr", high: 20, low: 0, refMale: [0, 15], refFemale: [0, 20], normalText: "Normal" }
                ]
            },
            "MAL": {
                title: "Malaria Test",
                params: [
                    { key: "MP Antigen (PF/PV)", unit: "", type: "select", options: ["Negative", "Positive"], normalText: "Negative" },
                    { key: "Peripheral Smear", unit: "", type: "textarea", normalText: "No malarial parasite seen." }
                ]
            },
            "TYPH": {
    title: "Typhoid (Widal Test)",
    params: [
        { 
            key: "S. Typhi O Antigen (TO)", 
            unit: "Titre", 
            low: 0, 
            high: 80, 
            note: "≥1:160 indicates active infection" 
        },
        { 
            key: "S. Typhi H Antigen (TH)", 
            unit: "Titre", 
            low: 0, 
            high: 80, 
            note: "≥1:160 indicates active infection" 
        },
        { 
            key: "S. Paratyphi A Antigen (AH)", 
            unit: "Titre", 
            low: 0, 
            high: 40, 
            note: "≥1:80 indicates infection" 
        },
        { 
            key: "S. Paratyphi B Antigen (BH)", 
            unit: "Titre", 
            low: 0, 
            high: 40, 
            note: "≥1:80 indicates infection" 
        }
    ]
},
            "HBSAG": {
                title: "HBsAg Test",
                params: [
                    { key: "HBsAg", unit: "", type: "select", options: ["Non-Reactive", "Reactive"], normalText: "Non-Reactive" }
                ]
            },
            "VITB12": {
                title: "Vitamin B12",
                params: [
                    { key: "Vitamin B12", unit: "pg/mL", low: 200, high: 900 }
                ]
            }
        };
        
    	
let state = {
        patient: {},
        selectedTests: [],
        values: {}
    };

    const el = {
        p_name: document.getElementById('p_name'),
        p_id: document.getElementById('p_id'),
        p_age: document.getElementById('p_age'),
        p_gender: document.getElementById('p_gender'),
        p_date: document.getElementById('p_date'),
        p_test: document.getElementById('p_test'),
        p_ref: document.getElementById('p_ref'),
        patientDetailsPanel: document.getElementById('patientDetailsPanel'),
        panelForm: document.getElementById('panelForm'),
        previewContent: document.getElementById('previewContent'),
        formHeading: document.getElementById('formHeading'),
        paramsArea: document.getElementById('paramsArea'),
        saveProceed: document.getElementById('saveProceed'),
        printReport: document.getElementById('printReport'),
        backToHome: document.getElementById('backToHome'),
        clearValues: document.getElementById('clearValues'),
        alertPlaceholder: document.getElementById('alertPlaceholder')
    };

    function showAlert(message) {
        el.alertPlaceholder.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function show(panelId) {
        el.patientDetailsPanel.classList.toggle('d-none', panelId === 'form');
        el.panelForm.classList.toggle('d-none', panelId === 'home');
    }

    function buildForm() {
        el.paramsArea.innerHTML = '';
        el.formHeading.textContent = `Enter Values for Selected Tests`;

        state.selectedTests.forEach(testKey => {
            const test = TESTS[testKey];
            if (!test) return;

            state.values[testKey] = state.values[testKey] || {};
            let formHtml = `<h6 class="mt-4 fw-bold">${test.title}</h6><hr>`;

            formHtml += test.params.map(p => {
                const val = state.values[testKey][p.key] || '';
                let inputHtml = `<input type="text" class="form-control" value="${val}" data-key="${p.key}" data-test="${testKey}"/>`;
                return `
                    <div class="mb-3">
                        <label class="form-label mb-1">${p.key} (${p.unit})</label>
                        ${inputHtml}
                        <small class="form-text text-muted">Reference: ${p.low ?? ''} - ${p.high ?? ''}</small>
                    </div>`;
            }).join('');

            el.paramsArea.innerHTML += formHtml;
        });
    }

    function refreshPreview() {
        const patient = state.patient;
        if (state.selectedTests.length === 0 || !patient.name) {
            el.previewContent.innerHTML = `<p class="text-muted text-center">Your report preview will appear here.</p>`;
            return;
        }

        let reportHtml = `
        <div class="border rounded p-3 small">
            <div class="row row-cols-2 g-2">
                <div><b>Patient Name:</b> ${patient.name || '-'}</div>
                <div><b>ID:</b> ${patient.id || '-'}</div>
                <div><b>Age/Gender:</b> ${patient.age || '-'} / ${patient.gender || '-'}</div>
                <div><b>Date:</b> ${patient.date || '-'}</div>
                <div><b>Ref. Doctor:</b> ${patient.ref || '-'}</div>
            </div>
        </div>`;

        state.selectedTests.forEach(testKey => {
            const test = TESTS[testKey];
            const values = state.values[testKey] || {};
            reportHtml += `
                <h6 class="mt-4 fw-bold">${test.title}</h6>
                <table class="table table-sm mt-2">
                    <thead><tr><th>Parameter</th><th>Value</th><th>Unit</th></tr></thead><tbody>
            `;
            test.params.forEach(p => {
                const value = values[p.key] || '-';
                reportHtml += `<tr><td>${p.key}</td><td>${value}</td><td>${p.unit || '-'}</td></tr>`;
            });
            reportHtml += `</tbody></table>`;
        });

        el.previewContent.innerHTML = reportHtml;
    }

    // --- Event Listeners ---
    el.saveProceed.addEventListener('click', () => {
        state.patient = {
            name: el.p_name.value,
            id: el.p_id.value,
            age: el.p_age.value,
            gender: el.p_gender.value,
            date: el.p_date.value,
            ref: el.p_ref.value
        };
        state.selectedTests = Array.from(el.p_test.selectedOptions).map(opt => opt.value);

        if (!state.patient.name || state.selectedTests.length === 0) {
            showAlert("Please fill patient name and select tests.");
            return;
        }
        show('form');
        buildForm();
        refreshPreview();
    });

    el.paramsArea.addEventListener('input', (e) => {
        if (e.target.dataset.test && e.target.dataset.key) {
            const { test, key } = e.target.dataset;
            state.values[test][key] = e.target.value;
            refreshPreview();
        }
    });

    el.printReport.addEventListener('click', () => {
        const printContent = el.previewContent.innerHTML;
        const w = window.open('', '', 'width=900,height=650');
        w.document.write(`<html><head><title>Lab Report</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"></head>
        <body>${printContent}</body></html>`);
        w.document.close();
        w.print();
    });

    el.backToHome.addEventListener('click', () => {
        show('home');
    });

    el.clearValues.addEventListener('click', () => {
        state = { patient: {}, selectedTests: [], values: {} };
        el.p_name.value = '';
        el.p_id.value = '';
        el.p_age.value = '';
        el.p_gender.value = '';
        el.p_date.value = '';
        el.p_ref.value = '';
        el.previewContent.innerHTML = `<p class="text-muted text-center">Your report preview will appear here.</p>`;
        show('home');
    });
</script>
</body>
</html>
